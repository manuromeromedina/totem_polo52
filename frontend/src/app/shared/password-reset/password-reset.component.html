<div class="reset-password-container">
  <div class="reset-password-box">
    <!-- Loading inicial -->
    <div *ngIf="loading && !error && !message" class="loading-container">
      <i class="fas fa-spinner"></i>
      <p>Verificando enlace...</p>
    </div>

    <!-- Header con estilo del login -->
    <div *ngIf="!loading || error || message" class="header">
      <h2>
        <i class="fas fa-key" style="margin-right: 12px; font-size: 1.5rem"></i>
        Restablecer Contraseña
      </h2>
      <p
        class="subtitle"
        *ngIf="!tokenExpired && !tokenUsed && token && userName"
      >
        Nueva contraseña para: <strong>{{ userName }}</strong>
      </p>
      <p
        class="subtitle"
        *ngIf="!tokenExpired && !tokenUsed && token && !userName"
      >
        Ingresa tu nueva contraseña segura
      </p>
      <p class="subtitle" *ngIf="tokenExpired">
        Enlace de recuperación expirado
      </p>
      <p class="subtitle" *ngIf="tokenUsed">
        Enlace de recuperación ya utilizado
      </p>
      <p class="subtitle" *ngIf="!token && !tokenExpired && !tokenUsed">
        Enlace de recuperación inválido
      </p>
    </div>

    <!-- Token expirado o usado - Casos especiales -->
    <div *ngIf="tokenExpired || tokenUsed" class="expired-container">
      <div class="icon-container">
        <i [class]="tokenExpired ? 'fas fa-clock' : 'fas fa-ban'"></i>
      </div>
      <h3>{{ tokenExpired ? "Enlace Expirado" : "Enlace Ya Utilizado" }}</h3>
      <p *ngIf="tokenExpired">
        Este enlace de recuperación de contraseña ya no es válido.
      </p>
      <p *ngIf="tokenUsed">
        Este enlace de recuperación ya fue utilizado para cambiar la contraseña.
      </p>
      <p class="subtitle">
        {{
          tokenExpired
            ? "Los enlaces de recuperación expiran por seguridad después de 1 hora."
            : "Por seguridad, cada enlace de recuperación solo puede usarse una vez."
        }}
      </p>

      <div class="button-group">
        <button type="button" class="primary-button" (click)="requestNewLink()">
          <i class="fas fa-paper-plane"></i>
          Solicitar Nuevo Enlace
        </button>
        <button type="button" class="secondary-button" (click)="goToLogin()">
          <i class="fas fa-arrow-left"></i>
          Volver al Login
        </button>
      </div>
    </div>

    <!-- Error si no hay token -->
    <div *ngIf="!token && !tokenExpired && !tokenUsed" class="error-container">
      <div class="error-message">
        <i class="fas fa-exclamation-triangle"></i>
        <span>{{
          error || "Token no válido o ausente. Por favor, verifica el enlace."
        }}</span>
      </div>
      <div class="button-group">
        <button type="button" class="secondary-button" (click)="goToLogin()">
          <i class="fas fa-arrow-left"></i>
          Volver al Login
        </button>
      </div>
    </div>

    <!-- Formulario de reset (solo si hay token válido) - SIN contraseña actual -->
    <form
      *ngIf="token && !tokenExpired && !tokenUsed && !loading"
      #resetForm="ngForm"
      (ngSubmit)="onResetPassword(resetForm)"
    >
      <!-- Campo de nueva contraseña -->
      <div class="form-group">
        <label for="newPassword">
          <i class="fas fa-lock"></i>
          Nueva Contraseña
        </label>
        <input
          id="newPassword"
          name="newPassword"
          type="password"
          [(ngModel)]="newPassword"
          (ngModelChange)="onNewPasswordChange()"
          placeholder="Mínimo 8 caracteres, 1 mayúscula, 1 número"
          required
          minlength="8"
          [class.error]="newPassword && (!isPasswordValid() || passwordReused)"
          [class.success]="newPassword && isPasswordValid() && !passwordReused"
        />

        <!-- Spinner de validación -->
        <div *ngIf="validatingPassword" class="field-hint">
          <i class="fas fa-spinner fa-spin"></i>
          Validando contraseña...
        </div>

        <!-- Error de contraseña reutilizada -->
        <div *ngIf="passwordReused" class="field-hint error">
          <i class="fas fa-ban"></i>
          Esta contraseña ya fue utilizada anteriormente
        </div>

        <!-- Indicadores de requisitos de contraseña -->
        <div *ngIf="newPassword" class="password-requirements">
          <div class="requirement-title">
            <i class="fas fa-shield-alt"></i>
            Requisitos de seguridad:
          </div>
          <div
            class="requirement"
            [class.valid]="getPasswordRequirements().minLength"
          >
            <i
              [class]="
                getPasswordRequirements().minLength
                  ? 'fas fa-check'
                  : 'fas fa-times'
              "
            ></i>
            Al menos 8 caracteres
          </div>
          <div
            class="requirement"
            [class.valid]="getPasswordRequirements().hasUppercase"
          >
            <i
              [class]="
                getPasswordRequirements().hasUppercase
                  ? 'fas fa-check'
                  : 'fas fa-times'
              "
            ></i>
            Una letra mayúscula
          </div>
          <div
            class="requirement"
            [class.valid]="getPasswordRequirements().hasNumber"
          >
            <i
              [class]="
                getPasswordRequirements().hasNumber
                  ? 'fas fa-check'
                  : 'fas fa-times'
              "
            ></i>
            Al menos un número
          </div>
          <div
            class="requirement"
            [class.valid]="!passwordReused && !validatingPassword"
          >
            <i
              [class]="
                !passwordReused && !validatingPassword
                  ? 'fas fa-check'
                  : validatingPassword
                  ? 'fas fa-spinner fa-spin'
                  : 'fas fa-times'
              "
            ></i>
            No utilizada anteriormente
          </div>
        </div>
      </div>

      <!-- Campo de confirmación de contraseña -->
      <div class="form-group">
        <label for="confirmPassword">
          <i class="fas fa-lock"></i>
          Confirmar Nueva Contraseña
        </label>
        <input
          id="confirmPassword"
          name="confirmPassword"
          type="password"
          [(ngModel)]="confirmPassword"
          placeholder="Repite la nueva contraseña"
          required
          minlength="8"
          [class.error]="confirmPassword && !doPasswordsMatch()"
          [class.success]="confirmPassword && doPasswordsMatch()"
        />
        <div
          *ngIf="confirmPassword && !doPasswordsMatch()"
          class="field-hint error"
        >
          <i class="fas fa-times"></i>
          Las contraseñas no coinciden
        </div>
        <div
          *ngIf="confirmPassword && doPasswordsMatch()"
          class="field-hint success"
        >
          <i class="fas fa-check"></i>
          Las contraseñas coinciden
        </div>
      </div>

      <!-- Información de seguridad para recuperación -->
      <div class="security-info">
        <div class="security-title">
          <i class="fas fa-info-circle"></i>
          Información de Seguridad
        </div>
        <ul>
          <li>No necesitas tu contraseña anterior para este proceso</li>
          <li>No podrás reutilizar contraseñas que ya hayas usado</li>
          <li>
            La nueva contraseña debe cumplir todos los requisitos de seguridad
          </li>
          <li>Este enlace se invalidará después de usarlo una vez</li>
          <li>El proceso es seguro gracias al token enviado por email</li>
        </ul>
      </div>

      <div class="button-group">
        <button
          type="submit"
          class="primary-button"
          [disabled]="!isFormValid() || loading"
        >
          <i *ngIf="loading" class="fas fa-spinner fa-spin"></i>
          <i *ngIf="!loading" class="fas fa-shield-alt"></i>
          {{
            loading
              ? "Actualizando Contraseña..."
              : "Establecer Nueva Contraseña"
          }}
        </button>

        <button type="button" class="secondary-button" (click)="goToLogin()">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
      </div>
    </form>

    <!-- Mensajes de estado -->
    <div *ngIf="message" class="success-container">
      <div class="success-message">
        <i class="fas fa-check-circle"></i>
        <span>{{ message }}</span>
      </div>
    </div>

    <div
      *ngIf="error && token && !tokenExpired && !tokenUsed"
      class="error-container"
    >
      <div class="error-message">
        <i class="fas fa-exclamation-triangle"></i>
        <span>{{ error }}</span>
      </div>
    </div>
  </div>
</div>
