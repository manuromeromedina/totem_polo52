<!-- password-reset.component.html -->
<div class="password-reset-container">
  <div class="reset-card">
    <!-- Panel Izquierdo - Información -->
    <div class="reset-left-panel">
      <div class="reset-logo-section">
        <div class="reset-logo-icon">
          <i class="fas fa-key"></i>
        </div>
        <div class="reset-logo-text">
          <h1>POLO 52</h1>
          <p class="subtitle">Recuperación Segura</p>
        </div>
      </div>

      <div class="reset-content-section">
        <h2>Restablecer<br /><span class="highlight">Contraseña</span></h2>
        <p>
          Crea una nueva contraseña segura para tu cuenta empresarial. El
          sistema garantiza la protección de tus datos mediante encriptación
          avanzada.
        </p>

        <ul class="reset-features">
          <li><i class="fas fa-shield-alt"></i> Proceso seguro y encriptado</li>
          <li><i class="fas fa-clock"></i> Enlace válido por 60 minutos</li>
          <li>
            <i class="fas fa-envelope-circle-check"></i> Confirmación automática
          </li>
          <li>
            <i class="fas fa-history"></i> No reutilizar contraseñas anteriores
          </li>
        </ul>
      </div>

      <div class="reset-security-info">
        <i class="fas fa-lock"></i>
        <span>Conexión SSL Segura</span>
      </div>
    </div>

    <!-- Panel Derecho - Formulario/Estados -->
    <div class="reset-right-panel">
      <!-- Botón de cerrar -->
      <button class="reset-close-btn" (click)="goToLogin()">
        <i class="fas fa-times"></i>
      </button>

      <!-- Header del reset - dinámico según estado -->
      <div class="reset-header">
        <div class="reset-icon">
          <i
            class="fas"
            [ngClass]="{
              'fa-spinner fa-spin': verifyingToken,
              'fa-key': tokenValid && !resetCompleted,
              'fa-clock': tokenExpired,
              'fa-check-circle': tokenUsed || resetCompleted,
              'fa-exclamation-triangle':
                !tokenValid && !verifyingToken && !tokenExpired && !tokenUsed
            }"
          ></i>
        </div>
        <h2>
          <span *ngIf="verifyingToken">Verificando Enlace</span>
          <span *ngIf="tokenValid && !resetCompleted"
            >Restablecer Contraseña</span
          >
          <span *ngIf="tokenExpired">Enlace Expirado</span>
          <span *ngIf="tokenUsed">Enlace Ya Utilizado</span>
          <span *ngIf="resetCompleted">¡Contraseña Restablecida!</span>
          <span
            *ngIf="
              !tokenValid &&
              !verifyingToken &&
              !tokenExpired &&
              !tokenUsed &&
              error
            "
            >Error en el Enlace</span
          >
        </h2>
        <p>
          <span *ngIf="verifyingToken"
            >Verificando enlace de recuperación...</span
          >
          <span *ngIf="tokenValid && !resetCompleted"
            >Ingresa tu nueva contraseña para
            <strong>{{ userName || userEmail }}</strong></span
          >
          <span *ngIf="tokenExpired"
            >El enlace de recuperación ha caducado</span
          >
          <span *ngIf="tokenUsed"
            >Este enlace ya fue procesado anteriormente</span
          >
          <span *ngIf="resetCompleted" style="color: #bbf7d0"
            >Tu contraseña ha sido actualizada exitosamente</span
          >
          <span
            *ngIf="
              !tokenValid &&
              !verifyingToken &&
              !tokenExpired &&
              !tokenUsed &&
              error
            "
            >El enlace no es válido o ha ocurrido un error</span
          >
        </p>
      </div>

      <!-- Estados del token -->

      <!-- Verificando token -->
      <div *ngIf="verifyingToken" class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Verificando enlace de recuperación...</p>
      </div>

      <!-- Token expirado -->
      <div *ngIf="tokenExpired" class="error-state">
        <i class="fas fa-clock"></i>
        <h3>Enlace Expirado</h3>
        <p>Este enlace de recuperación ha expirado por seguridad.</p>
        <button class="btn btn-primary" (click)="requestNewLink()">
          Solicitar Nuevo Enlace
        </button>
      </div>

      <!-- Token ya usado -->
      <div *ngIf="tokenUsed && !resetCompleted" class="error-state">
        <h3>Enlace Ya Utilizado</h3>
        <p>Este enlace de recuperación ya fue utilizado anteriormente.</p>
        <div class="button-group">
          <button class="btn btn-secondary" (click)="goToLogin()">
            Ir al Login
          </button>
          <button class="btn btn-primary" (click)="requestNewLink()">
            Nuevo Enlace
          </button>
        </div>
      </div>

      <!-- Formulario de reset (solo si token válido y no completado) -->
      <div
        *ngIf="tokenValid && !resetCompleted && !verifyingToken"
        class="reset-form-container"
      >
        <!-- Mensaje de éxito -->
        <div *ngIf="successMessage && !error" class="alert alert-success">
          <i class="fas fa-check-circle"></i>
          {{ successMessage }}
        </div>

        <!-- Mensaje de error general -->
        <div *ngIf="error && !successMessage" class="alert alert-error">
          <i class="fas fa-exclamation-triangle"></i>
          {{ error }}
        </div>

        <form
          #resetForm="ngForm"
          (ngSubmit)="onResetPassword(resetForm)"
          novalidate
        >
          <!-- Nueva Contraseña -->
          <div class="form-group">
            <label for="newPassword" class="form-label required">
              <i class="fas fa-key"></i>
              Nueva Contraseña
            </label>
            <div class="input-group">
              <input
                type="password"
                id="newPassword"
                name="newPassword"
                [(ngModel)]="newPassword"
                (input)="onNewPasswordChange()"
                class="form-control"
                [class.is-invalid]="newPassword && !isPasswordValid()"
                [class.is-valid]="
                  newPassword && isPasswordValid() && !passwordReused
                "
                placeholder="Ingresa tu nueva contraseña"
                required
                minlength="8"
                maxlength="128"
                [disabled]="loading"
              />
              <div class="input-group-append">
                <span class="input-group-text">
                  <i
                    class="fas fa-key"
                    [class.text-success]="
                      newPassword && isPasswordValid() && !passwordReused
                    "
                    [class.text-danger]="
                      newPassword && (!isPasswordValid() || passwordReused)
                    "
                  >
                  </i>
                </span>
              </div>
            </div>

            <!-- Indicadores de requisitos de contraseña -->
            <div class="password-requirements" *ngIf="newPassword">
              <div
                class="requirement"
                [class.valid]="getPasswordRequirements().minLength"
              >
                <i
                  class="fas"
                  [class.fa-check]="getPasswordRequirements().minLength"
                  [class.fa-times]="!getPasswordRequirements().minLength"
                ></i>
                Mínimo 8 caracteres
              </div>
              <div
                class="requirement"
                [class.valid]="getPasswordRequirements().hasUppercase"
              >
                <i
                  class="fas"
                  [class.fa-check]="getPasswordRequirements().hasUppercase"
                  [class.fa-times]="!getPasswordRequirements().hasUppercase"
                ></i>
                Al menos una mayúscula
              </div>
              <div
                class="requirement"
                [class.valid]="getPasswordRequirements().hasLowercase"
              >
                <i
                  class="fas"
                  [class.fa-check]="getPasswordRequirements().hasLowercase"
                  [class.fa-times]="!getPasswordRequirements().hasLowercase"
                ></i>
                Al menos una minúscula
              </div>
              <div
                class="requirement"
                [class.valid]="getPasswordRequirements().hasNumber"
              >
                <i
                  class="fas"
                  [class.fa-check]="getPasswordRequirements().hasNumber"
                  [class.fa-times]="!getPasswordRequirements().hasNumber"
                ></i>
                Al menos un número
              </div>
              <div
                class="requirement"
                [class.valid]="!passwordReused"
                [class.invalid]="passwordReused"
              >
                <i
                  class="fas"
                  [class.fa-check]="!passwordReused"
                  [class.fa-times]="passwordReused"
                ></i>
                No utilizada anteriormente
              </div>
            </div>

            <!-- Error de contraseña reutilizada -->
            <div *ngIf="passwordReused" class="field-error">
              <i class="fas fa-history"></i>
              No puedes usar una contraseña que ya hayas utilizado
              anteriormente.
            </div>
          </div>

          <!-- Confirmar Nueva Contraseña -->
          <div class="form-group">
            <label for="confirmPassword" class="form-label required">
              <i class="fas fa-check-double"></i>
              Confirmar Nueva Contraseña
            </label>
            <div class="input-group">
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                [(ngModel)]="confirmPassword"
                (input)="onConfirmPasswordChange()"
                class="form-control"
                [class.is-invalid]="confirmPassword && !doPasswordsMatch()"
                [class.is-valid]="
                  confirmPassword && doPasswordsMatch() && isPasswordValid()
                "
                placeholder="Confirma tu nueva contraseña"
                required
                minlength="8"
                maxlength="128"
                [disabled]="loading"
              />
              <div class="input-group-append">
                <span class="input-group-text">
                  <i
                    class="fas fa-check-double"
                    [class.text-success]="
                      confirmPassword && doPasswordsMatch() && isPasswordValid()
                    "
                    [class.text-danger]="confirmPassword && !doPasswordsMatch()"
                  >
                  </i>
                </span>
              </div>
            </div>

            <!-- Error de contraseñas no coincidentes -->
            <div
              *ngIf="confirmPassword && !doPasswordsMatch()"
              class="field-error"
            >
              <i class="fas fa-exclamation-circle"></i>
              Las contraseñas no coinciden
            </div>
          </div>

          <!-- Información de seguridad -->
          <div class="security-info">
            <div class="info-item">
              <i class="fas fa-info-circle"></i>
              <span
                >Este enlace expira en 1 hora y solo se puede usar una
                vez.</span
              >
            </div>
            <div class="info-item">
              <i class="fas fa-shield-alt"></i>
              <span>No podrás reutilizar contraseñas anteriores.</span>
            </div>
          </div>

          <!-- Botones -->
          <div class="form-actions">
            <button
              type="submit"
              class="btn btn-primary btn-block"
              [disabled]="!isFormValid() || loading"
              [class.loading]="loading"
            >
              <i
                class="fas fa-spinner fa-spin"
                *ngIf="loading; else resetIcon"
              ></i>
              <ng-template #resetIcon> </ng-template>
              {{ loading ? "Restableciendo..." : "Restablecer Contraseña" }}
            </button>
          </div>
        </form>
      </div>

      <!-- Estado de éxito completo -->
      <div *ngIf="resetCompleted" class="success-state">
        <i class="fas fa-check-circle"></i>
        <h3>¡Contraseña Restablecida!</h3>
        <p>{{ successMessage }}</p>
        <p class="redirect-info">
          <i class="fas fa-clock"></i>
          Serás redirigido al login en 5 segundos...
        </p>
        <button class="btn btn-primary" (click)="goToLogin()">
          Ir al Login Ahora
        </button>
      </div>

      <!-- Error general (token inválido, etc.) -->
      <div
        *ngIf="
          !tokenValid && !verifyingToken && !tokenExpired && !tokenUsed && error
        "
        class="error-state"
      >
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Error en el Enlace</h3>
        <p>{{ error }}</p>
        <div class="button-group">
          <button class="btn btn-secondary" (click)="goToLogin()">
            Ir al Login
          </button>
          <button class="btn btn-primary" (click)="requestNewLink()">
            Solicitar Nuevo Enlace
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
