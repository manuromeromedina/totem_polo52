<!-- password-reset.component.html -->
<div class="reset-modal-overlay">
  <div class="reset-modal">
    <!-- Panel Izquierdo - Info (idéntico al modal original) -->
    <div class="reset-left-panel">
      <div class="reset-logo-section">
        <div class="reset-logo-icon">
          <i class="fas fa-key"></i>
        </div>
        <div class="reset-logo-text">
          <h3>Recuperación<br /><span class="highlight">Segura</span></h3>
        </div>
      </div>

      <div class="reset-content-section">
        <h4>Restablecer Contraseña</h4>
        <p>
          Crea una nueva contraseña segura para tu cuenta empresarial. El
          sistema garantiza la protección de tus datos mediante encriptación
          avanzada.
        </p>

        <ul class="reset-features">
          <li><i class="fas fa-shield-alt"></i> Proceso seguro y encriptado</li>
          <li><i class="fas fa-clock"></i> Enlace válido por 60 minutos</li>
          <li>
            <i class="fas fa-envelope-circle-check"></i> Confirmación automática
          </li>
          <li>
            <i class="fas fa-history"></i> No reutilizar contraseñas anteriores
          </li>
        </ul>
      </div>

      <div class="reset-security-info">
        <i class="fas fa-lock"></i>
        <span>Conexión SSL Segura</span>
      </div>
    </div>

    <!-- Panel Derecho - Formulario/Estados -->
    <div class="reset-right-panel">
      <!-- Header del reset - dinámico según estado -->
      <div class="reset-header">
        <div class="reset-icon">
          <i
            class="fas"
            [ngClass]="{
              'fa-spinner fa-spin': verifyingToken,
              'fa-key': tokenValid && !resetCompleted,
              'fa-clock': tokenExpired,
              'fa-check-circle': tokenUsed || resetCompleted,
              'fa-exclamation-triangle':
                !tokenValid && !verifyingToken && !tokenExpired && !tokenUsed
            }"
          ></i>
        </div>
        <h3>
          <span *ngIf="verifyingToken">Verificando Enlace</span>
          <span *ngIf="tokenValid && !resetCompleted"
            >Restablecer Contraseña</span
          >
          <span *ngIf="tokenExpired">Enlace Expirado</span>
          <span *ngIf="tokenUsed">Enlace Ya Utilizado</span>
          <span *ngIf="resetCompleted">¡Contraseña Restablecida!</span>
          <span
            *ngIf="
              !tokenValid &&
              !verifyingToken &&
              !tokenExpired &&
              !tokenUsed &&
              error
            "
            >Error en el Enlace</span
          >
        </h3>
        <p>
          <span *ngIf="verifyingToken"
            >Verificando enlace de recuperación...</span
          >
          <span *ngIf="tokenValid && !resetCompleted"
            >Ingresa tu nueva contraseña para
            <strong>{{ userName || userEmail }}</strong></span
          >
          <span *ngIf="tokenExpired"
            >El enlace de recuperación ha caducado</span
          >
          <span *ngIf="tokenUsed"
            >Este enlace ya fue procesado anteriormente</span
          >
          <span *ngIf="resetCompleted" style="color: #10b981"
            >Tu contraseña ha sido actualizada exitosamente</span
          >
          <span
            *ngIf="
              !tokenValid &&
              !verifyingToken &&
              !tokenExpired &&
              !tokenUsed &&
              error
            "
            >El enlace no es válido o ha ocurrido un error</span
          >
        </p>
      </div>

      <!-- Estados del token -->

      <!-- Verificando token -->
      <div *ngIf="verifyingToken" class="loading-state">
        <div class="loading-content">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Verificando enlace de recuperación...</p>
        </div>
      </div>

      <!-- Token expirado -->
      <div *ngIf="tokenExpired" class="error-state">
        <div class="error-content">
          <i class="fas fa-clock"></i>
          <h4>Enlace Expirado</h4>
          <p>Este enlace de recuperación ha expirado por seguridad.</p>
          <button class="reset-button" (click)="requestNewLink()">
            Solicitar Nuevo Enlace
          </button>
        </div>
      </div>

      <!-- Token ya usado -->
      <div *ngIf="tokenUsed && !resetCompleted" class="error-state">
        <div class="error-content">
          <i class="fas fa-check-circle"></i>
          <h4>Enlace Ya Utilizado</h4>
          <p>Este enlace de recuperación ya fue utilizado anteriormente.</p>
          <div class="button-group">
            <button class="reset-button" (click)="requestNewLink()">
              Nuevo Enlace
            </button>
          </div>
        </div>
      </div>

      <!-- Formulario de reset (solo si token válido y no completado) -->
      <div
        *ngIf="tokenValid && !resetCompleted && !verifyingToken"
        class="reset-form-container"
      >
        <!-- Mensaje de éxito -->
        <div *ngIf="successMessage && !error" class="success-message">
          <i class="fas fa-check-circle"></i>
          {{ successMessage }}
        </div>

        <!-- Mensaje de error general -->
        <div *ngIf="error && !successMessage" class="field-error">
          <i class="fas fa-exclamation-triangle"></i>
          {{ error }}
        </div>

        <form
          #resetForm="ngForm"
          (ngSubmit)="onResetPassword(resetForm)"
          novalidate
        >
          <!-- Nueva Contraseña -->
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-key"></i>
              Nueva Contraseña
            </label>
            <div class="input-wrapper">
              <input
                type="password"
                name="newPassword"
                [(ngModel)]="newPassword"
                (input)="onNewPasswordChange()"
                class="form-input"
                [ngClass]="{
                  error: newPassword && (!isPasswordValid() || passwordReused),
                  valid: newPassword && isPasswordValid() && !passwordReused
                }"
                placeholder="Ingresa tu nueva contraseña"
                required
                minlength="8"
                maxlength="128"
                [disabled]="loading"
              />
            </div>

            <!-- Indicadores de requisitos de contraseña -->
            <div class="password-requirements" *ngIf="newPassword">
              <div
                class="requirement"
                [class.valid]="getPasswordRequirements().minLength"
              >
                <i
                  class="fas"
                  [class.fa-check]="getPasswordRequirements().minLength"
                  [class.fa-times]="!getPasswordRequirements().minLength"
                ></i>
                Mínimo 8 caracteres
              </div>
              <div
                class="requirement"
                [class.valid]="getPasswordRequirements().hasUppercase"
              >
                <i
                  class="fas"
                  [class.fa-check]="getPasswordRequirements().hasUppercase"
                  [class.fa-times]="!getPasswordRequirements().hasUppercase"
                ></i>
                Al menos una mayúscula
              </div>
              <div
                class="requirement"
                [class.valid]="getPasswordRequirements().hasLowercase"
              >
                <i
                  class="fas"
                  [class.fa-check]="getPasswordRequirements().hasLowercase"
                  [class.fa-times]="!getPasswordRequirements().hasLowercase"
                ></i>
                Al menos una minúscula
              </div>
              <div
                class="requirement"
                [class.valid]="getPasswordRequirements().hasNumber"
              >
                <i
                  class="fas"
                  [class.fa-check]="getPasswordRequirements().hasNumber"
                  [class.fa-times]="!getPasswordRequirements().hasNumber"
                ></i>
                Al menos un número
              </div>
              <div
                class="requirement"
                [class.valid]="!passwordReused"
                [class.invalid]="passwordReused"
              >
                <i
                  class="fas"
                  [class.fa-check]="!passwordReused"
                  [class.fa-times]="passwordReused"
                ></i>
                No utilizada anteriormente
              </div>
            </div>

            <!-- Error de contraseña reutilizada -->
            <span *ngIf="passwordReused" class="field-error">
              <i class="fas fa-history"></i>
              No puedes usar una contraseña que ya hayas utilizado
              anteriormente.
            </span>
          </div>

          <!-- Confirmar Nueva Contraseña -->
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-check-double"></i>
              Confirmar Nueva Contraseña
            </label>
            <div class="input-wrapper">
              <input
                type="password"
                name="confirmPassword"
                [(ngModel)]="confirmPassword"
                (input)="onConfirmPasswordChange()"
                class="form-input"
                [ngClass]="{
                  error: confirmPassword && !doPasswordsMatch(),
                  valid:
                    confirmPassword && doPasswordsMatch() && isPasswordValid()
                }"
                placeholder="Confirma tu nueva contraseña"
                required
                minlength="8"
                maxlength="128"
                [disabled]="loading"
              />
            </div>

            <!-- Error de contraseñas no coincidentes -->
            <span
              *ngIf="confirmPassword && !doPasswordsMatch()"
              class="field-error"
            >
              <i class="fas fa-exclamation-circle"></i>
              Las contraseñas no coinciden
            </span>
          </div>

          <!-- Información de seguridad -->
          <div class="reset-info-box">
            <i class="fas fa-info-circle"></i>
            <span
              >Este enlace expira en 1 hora y solo se puede usar una vez. No
              podrás reutilizar contraseñas anteriores.</span
            >
          </div>

          <!-- Botón -->
          <button
            type="submit"
            class="reset-button"
            [disabled]="!isFormValid() || loading"
            [ngClass]="{ loading: loading }"
          >
            {{ loading ? "Restableciendo..." : "Restablecer Contraseña" }}
          </button>
        </form>
      </div>

      <!-- Estado de éxito completo -->
      <div *ngIf="resetCompleted" class="success-state">
        <div class="success-content">
          <i class="fas fa-check-circle"></i>
          <h4>¡Contraseña Restablecida!</h4>
          <p>{{ successMessage }}</p>
          <p class="redirect-info">
            <i class="fas fa-clock"></i>
            Serás redirigido al login en 5 segundos...
          </p>
          <button class="reset-button" (click)="goToLogin()">
            Ir al Login Ahora
          </button>
        </div>
      </div>

      <!-- Error general (token inválido, etc.) -->
      <div
        *ngIf="
          !tokenValid && !verifyingToken && !tokenExpired && !tokenUsed && error
        "
        class="error-state"
      >
        <div class="error-content">
          <i class="fas fa-exclamation-triangle"></i>
          <h4>Error en el Enlace</h4>
          <p>{{ error }}</p>
          <div class="button-group">
            <button class="back-button" (click)="goToLogin()">
              <i class="fas fa-arrow-left"></i>
              Ir al Login
            </button>
            <button class="reset-button" (click)="requestNewLink()">
              Solicitar Nuevo Enlace
            </button>
          </div>
        </div>
      </div>

      <!-- Botón de volver (siempre visible) -->
      <button type="button" class="back-button-fixed" (click)="goToLogin()">
        <i class="fas fa-arrow-left"></i>
        Volver al inicio de sesión
      </button>
    </div>

    <!-- Botón de cerrar -->
    <button class="reset-close-btn" (click)="goToLogin()">
      <i class="fas fa-times"></i>
    </button>
  </div>
</div>
