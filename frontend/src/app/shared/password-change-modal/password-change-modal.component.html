<!-- shared/password-change-modal/password-change-modal.component.html -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <i class="fas fa-key"></i>
        Cambiar Contraseña
      </h2>
      <button type="button" class="close-btn" (click)="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <form
        #passwordForm="ngForm"
        (ngSubmit)="onChangePassword(passwordForm)"
        novalidate
      >
        <!-- Mensaje de éxito -->
        <div *ngIf="successMessage" class="alert alert-success">
          <i class="fas fa-check-circle"></i>
          {{ successMessage }}
        </div>

        <!-- Mensaje de error general -->
        <div *ngIf="error && !successMessage" class="alert alert-error">
          <i class="fas fa-exclamation-triangle"></i>
          {{ error }}
        </div>

        <!-- Contraseña Actual -->
        <div class="form-group">
          <label for="currentPassword" class="form-label required">
            <i class="fas fa-lock"></i>
            Contraseña Actual
          </label>
          <div class="input-group">
            <input
              type="password"
              id="currentPassword"
              name="currentPassword"
              [(ngModel)]="currentPassword"
              (input)="onCurrentPasswordChange()"
              class="form-control"
              [class.is-invalid]="wrongCurrentPassword || currentPasswordError"
              placeholder="Ingresa tu contraseña actual"
              required
              [disabled]="loading"
            />
            <div class="input-group-append">
              <span class="input-group-text">
                <i class="fas fa-shield-alt"></i>
              </span>
            </div>
          </div>

          <!-- Error específico de contraseña actual -->
          <div
            *ngIf="currentPasswordError || wrongCurrentPassword"
            class="field-error"
          >
            <i class="fas fa-exclamation-circle"></i>
            {{ currentPasswordError || "La contraseña actual es incorrecta" }}
          </div>
        </div>

        <!-- Nueva Contraseña -->
        <div class="form-group">
          <label for="newPassword" class="form-label required">
            <i class="fas fa-key"></i>
            Nueva Contraseña
          </label>
          <div class="input-group">
            <input
              type="password"
              id="newPassword"
              name="newPassword"
              [(ngModel)]="newPassword"
              (input)="onNewPasswordChange()"
              class="form-control"
              [class.is-invalid]="newPassword && !isPasswordValid()"
              [class.is-valid]="
                newPassword && isPasswordValid() && !passwordReused
              "
              placeholder="Ingresa tu nueva contraseña"
              required
              minlength="8"
              maxlength="128"
              [disabled]="loading"
            />
            <div class="input-group-append">
              <span class="input-group-text">
                <i
                  class="fas fa-key"
                  [class.text-success]="
                    newPassword && isPasswordValid() && !passwordReused
                  "
                  [class.text-danger]="
                    newPassword && (!isPasswordValid() || passwordReused)
                  "
                >
                </i>
              </span>
            </div>
          </div>

          <!-- Indicadores de requisitos de contraseña -->
          <div class="password-requirements" *ngIf="newPassword">
            <div
              class="requirement"
              [class.valid]="getPasswordRequirements().minLength"
            >
              <i
                class="fas"
                [class.fa-check]="getPasswordRequirements().minLength"
                [class.fa-times]="!getPasswordRequirements().minLength"
              ></i>
              Mínimo 8 caracteres
            </div>
            <div
              class="requirement"
              [class.valid]="getPasswordRequirements().hasUppercase"
            >
              <i
                class="fas"
                [class.fa-check]="getPasswordRequirements().hasUppercase"
                [class.fa-times]="!getPasswordRequirements().hasUppercase"
              ></i>
              Al menos una mayúscula
            </div>
            <div
              class="requirement"
              [class.valid]="getPasswordRequirements().hasLowercase"
            >
              <i
                class="fas"
                [class.fa-check]="getPasswordRequirements().hasLowercase"
                [class.fa-times]="!getPasswordRequirements().hasLowercase"
              ></i>
              Al menos una minúscula
            </div>
            <div
              class="requirement"
              [class.valid]="getPasswordRequirements().hasNumber"
            >
              <i
                class="fas"
                [class.fa-check]="getPasswordRequirements().hasNumber"
                [class.fa-times]="!getPasswordRequirements().hasNumber"
              ></i>
              Al menos un número
            </div>
            <div
              class="requirement"
              [class.valid]="!passwordReused"
              [class.invalid]="passwordReused"
            >
              <i
                class="fas"
                [class.fa-check]="!passwordReused"
                [class.fa-times]="passwordReused"
              ></i>
              No utilizada anteriormente
            </div>
          </div>

          <!-- Error de contraseña reutilizada -->
          <div *ngIf="passwordReused" class="field-error">
            <i class="fas fa-history"></i>
            No puedes usar una contraseña que ya hayas utilizado anteriormente.
          </div>
        </div>

        <!-- Confirmar Nueva Contraseña -->
        <div class="form-group">
          <label for="confirmPassword" class="form-label required">
            <i class="fas fa-check-double"></i>
            Confirmar Nueva Contraseña
          </label>
          <div class="input-group">
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              [(ngModel)]="confirmPassword"
              (input)="onConfirmPasswordChange()"
              class="form-control"
              [class.is-invalid]="confirmPassword && !doPasswordsMatch()"
              [class.is-valid]="
                confirmPassword && doPasswordsMatch() && isPasswordValid()
              "
              placeholder="Confirma tu nueva contraseña"
              required
              minlength="8"
              maxlength="128"
              [disabled]="loading"
            />
            <div class="input-group-append">
              <span class="input-group-text">
                <i
                  class="fas fa-check-double"
                  [class.text-success]="
                    confirmPassword && doPasswordsMatch() && isPasswordValid()
                  "
                  [class.text-danger]="confirmPassword && !doPasswordsMatch()"
                >
                </i>
              </span>
            </div>
          </div>

          <!-- Error de contraseñas no coincidentes -->
          <div
            *ngIf="confirmPassword && !doPasswordsMatch()"
            class="field-error"
          >
            <i class="fas fa-exclamation-circle"></i>
            Las contraseñas no coinciden
          </div>
        </div>

        <!-- Botones -->
        <div class="modal-actions">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="closeModal()"
            [disabled]="loading"
          >
            Cancelar
          </button>

          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="!isFormValid() || loading"
            [class.loading]="loading"
          >
            <i
              class="fas fa-spinner fa-spin"
              *ngIf="loading; else saveIcon"
            ></i>
            <ng-template #saveIcon> </ng-template>
            {{ loading ? "Actualizando..." : "Cambiar Contraseña" }}
          </button>
        </div>
      </form>

      <!-- Información de seguridad -->
      <div class="security-info">
        <div class="info-item">
          <i class="fas fa-info-circle"></i>
          <span>Tu sesión permanecerá activa después del cambio.</span>
        </div>
        <div class="info-item">
          <i class="fas fa-shield-alt"></i>
          <span>No podrás reutilizar contraseñas anteriores.</span>
        </div>
      </div>
    </div>
  </div>
</div>
