<!-- Botón para abrir el modal -->
<button class="btn btn-secondary" (click)="openModal()">
  Cambiar Contraseña
</button>
<!-- password-change-modal.component.html -->
<div class="modal-overlay" *ngIf="showModal">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- Header, Formulario y Footer tal como lo tenías -->
    <div class="modal-header">
      <h3>Cambiar Contraseña</h3>
      <button class="close-button" (click)="closeModal()" [disabled]="loading">
        X
      </button>
    </div>

    <div class="modal-content">
      <form #passwordForm="ngForm" (ngSubmit)="onChangePassword(passwordForm)">
        <!-- Campo Contraseña Actual -->
        <div class="form-group">
          <label for="currentPassword">
            <i class="fas fa-unlock-alt"></i>
            Contraseña Actual *
          </label>
          <input
            id="currentPassword"
            name="currentPassword"
            type="password"
            [(ngModel)]="currentPassword"
            placeholder="Ingresa tu contraseña actual para verificar tu identidad"
            required
            [class.error]="currentPasswordError"
            [class.success]="currentPassword && !currentPasswordError"
            [disabled]="loading"
          />
          <div
            *ngIf="currentPassword && !currentPasswordError"
            class="field-hint success"
          >
            <i class="fas fa-check"></i>
            Contraseña actual ingresada
          </div>
          <div *ngIf="currentPasswordError" class="field-hint error">
            <i class="fas fa-times"></i>
            {{ currentPasswordError }}
          </div>
        </div>

        <!-- Campo Nueva Contraseña -->
        <div class="form-group">
          <label for="newPassword">
            <i class="fas fa-lock"></i>
            Nueva Contraseña *
          </label>
          <input
            id="newPassword"
            name="newPassword"
            type="password"
            [(ngModel)]="newPassword"
            (ngModelChange)="onNewPasswordChange()"
            placeholder="Mínimo 8 caracteres, 1 mayúscula, 1 número"
            required
            minlength="8"
            [class.error]="
              newPassword && (!isPasswordValid() || passwordReused)
            "
            [class.success]="
              newPassword &&
              isPasswordValid() &&
              !passwordReused &&
              !validatingPassword
            "
            [disabled]="loading"
          />

          <div *ngIf="validatingPassword" class="field-hint">
            <i class="fas fa-spinner fa-spin"></i>
            Validando contraseña...
          </div>

          <div *ngIf="passwordReused" class="field-hint error">
            <i class="fas fa-ban"></i>
            Esta contraseña ya fue utilizada anteriormente
          </div>

          <!-- Indicadores de requisitos -->
          <div *ngIf="newPassword" class="password-requirements">
            <div class="requirement-title">
              <i class="fas fa-shield-alt"></i>
              Requisitos de seguridad:
            </div>
            <div
              class="requirement"
              [class.valid]="getPasswordRequirements().minLength"
            >
              <i
                [class]="
                  getPasswordRequirements().minLength
                    ? 'fas fa-check'
                    : 'fas fa-times'
                "
              ></i>
              Al menos 8 caracteres
            </div>
            <div
              class="requirement"
              [class.valid]="getPasswordRequirements().hasUppercase"
            >
              <i
                [class]="
                  getPasswordRequirements().hasUppercase
                    ? 'fas fa-check'
                    : 'fas fa-times'
                "
              ></i>
              Una letra mayúscula
            </div>
            <div
              class="requirement"
              [class.valid]="getPasswordRequirements().hasNumber"
            >
              <i
                [class]="
                  getPasswordRequirements().hasNumber
                    ? 'fas fa-check'
                    : 'fas fa-times'
                "
              ></i>
              Al menos un número
            </div>
            <div
              class="requirement"
              [class.valid]="!passwordReused && !validatingPassword"
            >
              <i
                [class]="
                  !passwordReused && !validatingPassword
                    ? 'fas fa-check'
                    : validatingPassword
                    ? 'fas fa-spinner fa-spin'
                    : 'fas fa-times'
                "
              ></i>
              No utilizada anteriormente
            </div>
          </div>
        </div>

        <!-- Campo Confirmar Contraseña -->
        <div class="form-group">
          <label for="confirmPassword">
            <i class="fas fa-lock"></i>
            Confirmar Nueva Contraseña *
          </label>
          <input
            id="confirmPassword"
            name="confirmPassword"
            type="password"
            [(ngModel)]="confirmPassword"
            placeholder="Repite la nueva contraseña"
            required
            minlength="8"
            [class.error]="confirmPassword && !doPasswordsMatch()"
            [class.success]="confirmPassword && doPasswordsMatch()"
            [disabled]="loading"
          />
          <div
            *ngIf="confirmPassword && !doPasswordsMatch()"
            class="field-hint error"
          >
            <i class="fas fa-times"></i>
            Las contraseñas no coinciden
          </div>
          <div
            *ngIf="confirmPassword && doPasswordsMatch()"
            class="field-hint success"
          >
            <i class="fas fa-check"></i>
            Las contraseñas coinciden
          </div>
        </div>

        <!-- Información de Seguridad -->
        <div class="security-info">
          <div class="security-title">
            <i class="fas fa-info-circle"></i>
            Información de Seguridad
          </div>
          <ul>
            <li>
              Debes ingresar tu contraseña actual para confirmar tu identidad
            </li>
            <li>
              No podrás reutilizar contraseñas que ya hayas usado anteriormente
            </li>
            <li>
              La nueva contraseña debe cumplir todos los requisitos de seguridad
            </li>
            <li>El cambio será efectivo inmediatamente</li>
            <li>Tu sesión actual se mantendrá activa después del cambio</li>
          </ul>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button
        class="btn btn-secondary"
        (click)="closeModal()"
        [disabled]="loading"
      >
        Cancelar
      </button>
      <button
        class="btn btn-primary"
        (click)="onChangePassword(passwordForm)"
        [disabled]="!isFormValid() || loading"
      >
        {{ loading ? "Cambiando..." : "Cambiar Contraseña" }}
      </button>
    </div>
  </div>
</div>
