<!-- password-change-modal.component.html -->
<div class="reset-modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="reset-modal" (click)="$event.stopPropagation()">
    <!-- Panel Izquierdo - Info (idéntico al modal original) -->
    <div class="reset-left-panel">
      <div class="reset-logo-section">
        <div class="reset-logo-icon">
          <i class="fas fa-key"></i>
        </div>
        <div class="reset-logo-text">
          <h3>Cambio<br /><span class="highlight">Seguro</span></h3>
        </div>
      </div>

      <div class="reset-content-section">
        <h4>Cambiar Contraseña</h4>
        <p>
          Actualiza tu contraseña de forma segura. Necesitas ingresar tu
          contraseña actual para confirmar tu identidad y proteger tu cuenta.
        </p>

        <ul class="reset-features">
          <li><i class="fas fa-shield-alt"></i> Verificación de identidad</li>
          <li><i class="fas fa-lock"></i> Encriptación avanzada</li>
          <li><i class="fas fa-user-check"></i> Sesión permanece activa</li>
          <li>
            <i class="fas fa-history"></i> No reutilizar contraseñas anteriores
          </li>
        </ul>
      </div>

      <div class="reset-security-info">
        <i class="fas fa-lock"></i>
        <span>Conexión SSL Segura</span>
      </div>
    </div>

    <!-- Panel Derecho - Formulario -->
    <div class="reset-right-panel">
      <div class="reset-header">
        <div class="reset-icon">
          <i class="fas fa-key"></i>
        </div>
        <h3>Cambiar Contraseña</h3>
        <p>Actualiza tu contraseña de acceso</p>
      </div>

      <!-- Mensaje de éxito -->
      <div *ngIf="successMessage" class="success-message">
        <i class="fas fa-check-circle"></i>
        {{ successMessage }}
      </div>

      <!-- Mensaje de error general -->
      <div *ngIf="error && !successMessage" class="field-error">
        <i class="fas fa-exclamation-triangle"></i>
        {{ error }}
      </div>

      <form
        #passwordForm="ngForm"
        (ngSubmit)="onChangePassword(passwordForm)"
        novalidate
      >
        <!-- Contraseña Actual -->
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-lock"></i>
            Contraseña Actual
          </label>
          <div class="input-wrapper">
            <input
              type="password"
              name="currentPassword"
              [(ngModel)]="currentPassword"
              (input)="onCurrentPasswordChange()"
              class="form-input"
              [ngClass]="{
                error: wrongCurrentPassword || currentPasswordError
              }"
              placeholder="Ingresa tu contraseña actual"
              required
              [disabled]="loading"
            />
          </div>

          <!-- Error específico de contraseña actual -->
          <span
            *ngIf="currentPasswordError || wrongCurrentPassword"
            class="field-error"
          >
            <i class="fas fa-exclamation-circle"></i>
            {{ currentPasswordError || "La contraseña actual es incorrecta" }}
          </span>
        </div>

        <!-- Nueva Contraseña -->
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-key"></i>
            Nueva Contraseña
          </label>
          <div class="input-wrapper">
            <input
              type="password"
              name="newPassword"
              [(ngModel)]="newPassword"
              (input)="onNewPasswordChange()"
              class="form-input"
              [ngClass]="{
                error: newPassword && (!isPasswordValid() || passwordReused),
                valid: newPassword && isPasswordValid() && !passwordReused
              }"
              placeholder="Ingresa tu nueva contraseña"
              required
              minlength="8"
              maxlength="128"
              [disabled]="loading"
            />
          </div>

          <!-- Indicadores de requisitos de contraseña -->
          <div class="password-requirements" *ngIf="newPassword">
            <div
              class="requirement"
              [class.valid]="getPasswordRequirements().minLength"
            >
              <i
                class="fas"
                [class.fa-check]="getPasswordRequirements().minLength"
                [class.fa-times]="!getPasswordRequirements().minLength"
              ></i>
              Mínimo 8 caracteres
            </div>
            <div
              class="requirement"
              [class.valid]="getPasswordRequirements().hasUppercase"
            >
              <i
                class="fas"
                [class.fa-check]="getPasswordRequirements().hasUppercase"
                [class.fa-times]="!getPasswordRequirements().hasUppercase"
              ></i>
              Al menos una mayúscula
            </div>
            <div
              class="requirement"
              [class.valid]="getPasswordRequirements().hasLowercase"
            >
              <i
                class="fas"
                [class.fa-check]="getPasswordRequirements().hasLowercase"
                [class.fa-times]="!getPasswordRequirements().hasLowercase"
              ></i>
              Al menos una minúscula
            </div>
            <div
              class="requirement"
              [class.valid]="getPasswordRequirements().hasNumber"
            >
              <i
                class="fas"
                [class.fa-check]="getPasswordRequirements().hasNumber"
                [class.fa-times]="!getPasswordRequirements().hasNumber"
              ></i>
              Al menos un número
            </div>
            <div
              class="requirement"
              [class.valid]="!passwordReused"
              [class.invalid]="passwordReused"
            >
              <i
                class="fas"
                [class.fa-check]="!passwordReused"
                [class.fa-times]="passwordReused"
              ></i>
              No utilizada anteriormente
            </div>
          </div>

          <!-- Error de contraseña reutilizada -->
          <span *ngIf="passwordReused" class="field-error">
            <i class="fas fa-history"></i>
            No puedes usar una contraseña que ya hayas utilizado anteriormente.
          </span>
        </div>

        <!-- Confirmar Nueva Contraseña -->
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-check-double"></i>
            Confirmar Nueva Contraseña
          </label>
          <div class="input-wrapper">
            <input
              type="password"
              name="confirmPassword"
              [(ngModel)]="confirmPassword"
              (input)="onConfirmPasswordChange()"
              class="form-input"
              [ngClass]="{
                error: confirmPassword && !doPasswordsMatch(),
                valid:
                  confirmPassword && doPasswordsMatch() && isPasswordValid()
              }"
              placeholder="Confirma tu nueva contraseña"
              required
              minlength="8"
              maxlength="128"
              [disabled]="loading"
            />
          </div>

          <!-- Error de contraseñas no coincidentes -->
          <span
            *ngIf="confirmPassword && !doPasswordsMatch()"
            class="field-error"
          >
            <i class="fas fa-exclamation-circle"></i>
            Las contraseñas no coinciden
          </span>
        </div>

        <!-- Información de seguridad -->
        <div class="reset-info-box">
          <i class="fas fa-info-circle"></i>
          <span
            >Tu sesión permanecerá activa después del cambio. No podrás
            reutilizar contraseñas anteriores.</span
          >
        </div>

        <!-- Botones -->
        <div class="modal-actions">
          <button
            type="button"
            class="back-button"
            (click)="closeModal()"
            [disabled]="loading"
          >
            Cancelar
          </button>

          <button
            type="submit"
            class="reset-button"
            [disabled]="!isFormValid() || loading"
            [ngClass]="{ loading: loading }"
          >
            {{ loading ? "Actualizando..." : "Cambiar Contraseña" }}
          </button>
        </div>
      </form>
    </div>

    <!-- Botón de cerrar -->
    <button class="reset-close-btn" (click)="closeModal()">
      <i class="fas fa-times"></i>
    </button>
  </div>
</div>
