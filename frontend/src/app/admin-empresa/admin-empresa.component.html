<!-- admin-empresa.component.html -->
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Material+Symbols+Outlined:FILL@0..1"
  rel="stylesheet"
/>

<div class="admin-layout">
  <!-- NAVBAR SUPERIOR -->
  <!-- TOP NAV -->
  <nav class="topbar">
    <div class="topbar-left">
      <img
        class="brand-logo"
        src="../../assets/images/polologo-blanco.png"
        alt="Polo 52"
      />
      <div class="topbar-title">
        <div class="app-title">POLO 52</div>
        <div class="app-sub">Parque Industrial</div>
      </div>
    </div>

    <div class="topbar-tabs">
      <button
        class="tab"
        [class.active]="activeTab === 'resumen'"
        (click)="goTo('resumen')"
      >
        Resumen
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'vehiculos'"
        (click)="goTo('vehiculos')"
      >
        Vehículos
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'servicios'"
        (click)="goTo('servicios')"
      >
        Servicios
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'contactos'"
        (click)="goTo('contactos')"
      >
        Contactos
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'perfil'"
        (click)="goTo('perfil')"
      >
        Mi Información
      </button>
    </div>

    <div class="topbar-right">
      <button class="pill">Empresa Activa</button>

      <button
        class="ghost topbar-icon-btn"
        (click)="goTo('config')"
        aria-label="Abrir configuración"
      >
        <span class="material-symbols-outlined">settings</span>
      </button>

      <app-logout-button></app-logout-button>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="content">
    <!-- ========== RESUMEN ============================================================================ -->
    <!-- RESUMEN -->
    <section *ngIf="activeTab === 'resumen'" class="resume-grid">
      <!-- Métricas -->
      <div class="kpi card">
        <div class="kpi-head">
          <div class="kpi-title">Vehículos Activos</div>
          <span class="material-symbols-outlined">local_shipping</span>
        </div>
        <div class="kpi-number">{{ vehiculosActivos }}</div>
        <div class="kpi-sub">de {{ vehiculosActivos }} total</div>
      </div>

      <div class="kpi card">
        <div class="kpi-head">
          <div class="kpi-title">Servicios</div>
          <span class="material-symbols-outlined">stacked_bar_chart</span>
        </div>
        <div class="kpi-number">{{ totalServicios }}</div>
        <div class="kpi-sub">servicios disponibles</div>
      </div>

      <div class="kpi card">
        <div class="kpi-head">
          <div class="kpi-title">Contactos</div>
          <span class="material-symbols-outlined">group</span>
        </div>
        <div class="kpi-number">{{ totalContactos }}</div>
        <div class="kpi-sub">contacto/s</div>
      </div>

      <div class="kpi card">
        <div class="kpi-head">
          <div class="kpi-title">Estado</div>
          <span class="material-symbols-outlined">schedule</span>
        </div>
        <div
          class="status"
          [class.active]="estaActiva"
          [class.inactive]="!estaActiva"
        >
          {{ estaActiva ? "Activo" : "Inactivo" }}
        </div>
        <div class="kpi-sub">desde {{ desdeIngreso }}</div>
      </div>

      <!-- Actividad reciente -->
      <div class="card activity">
        <h2>Actividad Reciente</h2>
        <ul class="activity-list" *ngIf="actividadReciente.length; else noAct">
          <li *ngFor="let a of actividadReciente">
            <span
              class="dot"
              [class.ok]="a.tipo === 'ok'"
              [class.warn]="a.tipo === 'warn'"
              [class.info]="a.tipo === 'info'"
            ></span>
            <div class="a-texts">
              <div class="a-title">{{ a.titulo }}</div>
              <div class="a-when">{{ a.cuando }}</div>
            </div>
          </li>
        </ul>
        <ng-template #noAct
          ><div class="muted">Sin actividad por ahora.</div></ng-template
        >
      </div>

      <!-- Accesos rápidos -->
      <div class="card quick">
        <h2>Accesos Rápidos</h2>
        <div class="quick-list">
          <button class="quick-btn" (click)="quickAddVehiculo()">
            <span class="material-symbols-outlined">add</span> Agregar Vehículo
          </button>
          <button class="quick-btn" (click)="quickAddServicio()">
            <span class="material-symbols-outlined">add</span> Nuevo Servicio
          </button>
          <button class="quick-btn" (click)="quickAddContacto()">
            <span class="material-symbols-outlined">add</span> Agregar Contacto
          </button>
        </div>
      </div>
    </section>

    <!-- PERFIL =========================================================================== -->
    <section *ngIf="activeTab === 'perfil'" class="card-grid">
      <!-- Datos solo-lectura -->
      <div class="card">
        <h2>Datos</h2>
        <div class="grid-2 nice-form">
          <div class="field">
            <label>CUIL</label>
            <input type="text" [value]="empresaData?.cuil" disabled />
          </div>
          <div class="field">
            <label>Nombre</label>
            <input type="text" [value]="empresaData?.nombre" disabled />
          </div>
          <div class="field">
            <label>Rubro</label>
            <input type="text" [value]="empresaData?.rubro" disabled />
          </div>
          <div class="field">
            <label>Fecha ingreso</label>
            <input
              type="text"
              [value]="formatDate(empresaData?.fecha_ingreso || '')"
              disabled
            />
          </div>
          <!-- NUEVOS (solo lectura en esta vista) -->
          <div class="field">
            <label>Cant. empleados</label>
            <input
              class="readout"
              type="text"
              [value]="empresaData?.cant_empleados || '—'"
              disabled
            />
          </div>
          <div class="field">
            <label>Horario trabajo</label>
            <input
              class="readout"
              type="text"
              [value]="empresaData?.horario_trabajo || '—'"
              disabled
            />
          </div>
          <div class="field col-2">
            <label>Observaciones</label>
            <textarea
              class="readout"
              rows="3"
              [value]="empresaData?.observaciones || '—'"
              disabled
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Editar empresa (self) -->
      <div class="card">
        <div class="actions">
          <button
            class="btn primary"
            type="button"
            (click)="openEmpresaEditForm()"
          >
            <span class="material-symbols-outlined">edit</span>
            <span>Editar datos</span>
          </button>
        </div>
      </div>
    </section>

    <!-- VEHICULOS ============================================================ -->
    <section *ngIf="activeTab === 'vehiculos'" class="card-stack">
      <div class="card">
        <div class="actions">
          <button
            class="btn primary"
            type="button"
            (click)="openVehiculoForm()"
          >
            <span class="material-symbols-outlined">add_circle</span>
            <span>Nuevo vehículo</span>
          </button>
        </div>
      </div>

      <!-- Listado -->
      <div class="card">
        <h2>Listado</h2>
        <div class="table">
          <div class="thead">
            <div>Tipo</div>
            <div>Horarios</div>
            <div>Frecuencia</div>
            <div>Datos</div>
            <div>Acciones</div>
          </div>

          <div class="row" *ngFor="let v of filteredVehiculos">
            <div>
              {{
                v.id_tipo_vehiculo
                  ? getTipoVehiculoName(v.id_tipo_vehiculo)
                  : "-"
              }}
            </div>

            <div>{{ v.horarios || "-" }}</div>
            <div>{{ v.frecuencia || "-" }}</div>
            <div>
              <ng-container *ngIf="v.datos">
                <span *ngIf="v.datos.cantidad"
                  >Cantidad: {{ v.datos.cantidad }}</span
                ><br />
                <span *ngIf="v.datos.patente"
                  >Patente: {{ v.datos.patente }}</span
                ><br />
                <span *ngIf="v.datos.carga">Carga: {{ v.datos.carga }}</span
                ><br />
                <span *ngIf="v.datos.descripcion">{{
                  v.datos.descripcion
                }}</span>
              </ng-container>
              <span *ngIf="!v.datos || !hasKeys(v.datos)">–</span>
            </div>

            <div class="row-actions">
              <button
                class="btn icon"
                title="Editar"
                (click)="openVehiculoForm(v)"
              >
                <span class="material-symbols-outlined">edit</span>
              </button>
              <button
                class="btn icon danger"
                title="Eliminar"
                (click)="deleteVehiculo(v.id_vehiculo)"
              >
                <span class="material-symbols-outlined">delete</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CONTACTOS ===================================================================================-->
    <section *ngIf="activeTab === 'contactos'" class="card-stack">
      <div class="card">
        <div class="actions">
          <button
            class="btn primary"
            type="button"
            (click)="openContactoForm()"
          >
            <span class="material-symbols-outlined">add_circle</span>
            <span>Nuevo contacto</span>
          </button>
        </div>
      </div>
      <div class="card">
        <h2>Listado</h2>

        <!-- tabla contactos con layout propio -->
        <div class="table table--contactos">
          <div class="thead">
            <div>Tipo</div>
            <div>Nombre</div>
            <div>Teléfono</div>
            <div>Dirección</div>
            <div>Datos</div>
            <div>Acciones</div>
          </div>

          <div class="row" *ngFor="let c of filteredContactos">
            <div>
              {{
                c.id_tipo_contacto
                  ? getTipoContactoName(c.id_tipo_contacto)
                  : "-"
              }}
            </div>

            <div>{{ c.nombre }}</div>
            <div>{{ c.telefono || "-" }}</div>
            <div>{{ c.direccion || "-" }}</div>

            <!-- DATOS: chips en columna; cada chip es 1 línea con ellipsis -->
            <div>
              <div class="data-stack">
                <a
                  *ngIf="c.datos?.pagina_web"
                  class="chip-link"
                  [href]="externalHref(c.datos.pagina_web)"
                  target="_blank"
                  rel="noopener"
                  title="{{ c.datos.pagina_web }}"
                >
                  <span class="material-symbols-outlined">language</span>
                  <span class="text">{{ displayUrl(c.datos.pagina_web) }}</span>
                </a>

                <a
                  *ngIf="c.datos?.correo"
                  class="chip-link"
                  [href]="'mailto:' + c.datos.correo"
                  title="{{ c.datos.correo }}"
                >
                  <span class="material-symbols-outlined">mail</span>
                  <span class="text">{{ c.datos.correo }}</span>
                </a>

                <a
                  *ngIf="c.datos?.redes_sociales"
                  class="chip-link"
                  [href]="externalHref(c.datos.redes_sociales)"
                  target="_blank"
                  rel="noopener"
                  title="{{ c.datos.redes_sociales }}"
                >
                  <span class="material-symbols-outlined">link</span>
                  <span class="text">{{
                    displayUrl(c.datos.redes_sociales)
                  }}</span>
                </a>

                <span
                  *ngIf="c.datos?.descripcion"
                  class="chip-plain"
                  title="{{ c.datos.descripcion }}"
                >
                  <span class="material-symbols-outlined">notes</span>
                  <span class="text">{{ c.datos.descripcion }}</span>
                </span>

                <span *ngIf="!c.datos || !hasKeys(c.datos)">–</span>
              </div>
            </div>

            <!-- Acciones: pegadas a la derecha -->
            <div class="row-actions">
              <button
                class="btn icon"
                title="Editar"
                (click)="openContactoForm(c)"
              >
                <span class="material-symbols-outlined">edit</span>
              </button>
              <button
                class="btn icon danger"
                title="Eliminar"
                (click)="deleteContacto(c.id_contacto)"
              >
                <span class="material-symbols-outlined">delete</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SERVICIOS PROPIOS ==============================================================================-->
    <section *ngIf="activeTab === 'servicios'" class="card-stack">
      <div class="card">
        <div class="actions">
          <button
            class="btn primary"
            type="button"
            (click)="openServicioForm()"
          >
            <span class="material-symbols-outlined">add_circle</span>
            <span>Nuevo servicio</span>
          </button>
        </div>
      </div>

      <div class="card">
        <h2>Listado</h2>
        <div class="table">
          <div class="thead">
            <div>Tipo</div>
            <div>Datos</div>
            <div>Acciones</div>
          </div>

          <div class="row" *ngFor="let s of filteredServicios">
            <div>
              {{
                s.id_tipo_servicio
                  ? getTipoServicioName(s.id_tipo_servicio)
                  : "-"
              }}
            </div>

            <div>
              <div>
                <ng-container *ngIf="s.datos">
                  <!-- Agua -->
                  <ng-container *ngIf="s.id_tipo_servicio === 1">
                    <span>Biofiltro: {{ s.datos.biofiltro }}</span
                    ><br />
                    <span
                      >Tratamiento: {{ s.datos.tratamiento_aguas_grises }}</span
                    >
                  </ng-container>

                  <!-- Espacios verdes -->
                  <ng-container *ngIf="s.id_tipo_servicio === 2">
                    <span>Abierto: {{ s.datos.abierto }}</span
                    ><br />
                    <span>Superficie: {{ s.datos.m2 }} m²</span>
                  </ng-container>

                  <!-- Internet -->
                  <ng-container *ngIf="s.id_tipo_servicio === 3">
                    <span>Tipo: {{ s.datos.tipo }}</span
                    ><br />
                    <span>Proveedor: {{ s.datos.proveedor }}</span>
                  </ng-container>

                  <!-- Residuos -->
                  <ng-container *ngIf="s.id_tipo_servicio === 4">
                    <span>Tipo: {{ s.datos.tipo }}</span
                    ><br />
                    <span>Cantidad: {{ s.datos.cantidad }}</span>
                  </ng-container>

                  <!-- Default -->
                  <ng-container *ngIf="!s.id_tipo_servicio">
                    <span>{{ s.datos.descripcion }}</span>
                  </ng-container>
                </ng-container>

                <span *ngIf="!s.datos || !hasKeys(s.datos)">–</span>
              </div>
            </div>
            <div class="row-actions">
              <button
                class="btn icon"
                title="Editar"
                (click)="openServicioForm(s)"
              >
                <span class="material-symbols-outlined">edit</span>
              </button>
              <button
                class="btn icon danger"
                title="Eliminar"
                (click)="deleteServicio(s.id_servicio)"
              >
                <span class="material-symbols-outlined">delete</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SERVICIOS POLO (solo lectura) ==================================================================-->
    <section *ngIf="activeTab === 'serviciosPolo'" class="card">
      <h2>Servicios del Polo asociados</h2>
      <div class="table">
        <div class="thead">
          <div>Nombre</div>
          <div>Tipo</div>
          <div>Horario</div>
          <div>Propietario</div>
          <div>Lotes</div>
        </div>

        <div class="row" *ngFor="let sp of filteredServiciosPolo">
          <div>{{ sp.nombre }}</div>
          <div>{{ sp.tipo_servicio_polo || "-" }}</div>
          <div>{{ sp.horario || "-" }}</div>
          <div>{{ sp.propietario || "-" }}</div>
          <div>
            <ng-container *ngIf="sp.lotes?.length; else sinLotes">
              <span *ngFor="let l of sp.lotes"
                >M{{ l.manzana }}-L{{ l.lote }}&nbsp;</span
              >
            </ng-container>
            <ng-template #sinLotes>–</ng-template>
          </div>
        </div>
      </div>
    </section>

    <!-- CONFIGURACIÓN  ==============================================================================-->
    <section *ngIf="activeTab === 'config'" class="card-grid">
      <!-- Contraseña -->
      <div class="card setting-card">
        <div class="setting-header">
          <span class="material-symbols-outlined setting-icon">vpn_key</span>
          <div>
            <h2>Contraseña</h2>
            <p class="muted">Actualiza tu contraseña de acceso</p>
          </div>
        </div>
        <button
          class="btn outline-primary"
          type="button"
          (click)="openPasswordModal()"
        >
          <span class="material-symbols-outlined">edit</span>
          <span>Cambiar contraseña</span>
        </button>
        <app-password-change-modal
          #passwordModal
          [showModal]="showPasswordModal"
          (modalClosed)="onPasswordModalClosed()"
          (passwordChanged)="onPasswordChanged($event)"
        >
        </app-password-change-modal>
      </div>

      <!-- Sesión -->
      <div class="card setting-card">
        <div class="setting-header">
          <span class="material-symbols-outlined setting-icon danger"
            >logout</span
          >
          <div>
            <h2>Sesión</h2>
            <p class="muted">Salir de la cuenta de empresa</p>
          </div>
        </div>
        <app-logout-button></app-logout-button>
      </div>
    </section>
  </main>
</div>

<!-- =============== OVERLAYS DE FORMULARIO ======================================================== -->
<!-- ============================================================================================== -->

<!-- Empresa: editar propios -->
<div class="overlay" *ngIf="showEmpresaEditForm">
  <div class="modal modal--md">
    <div class="modal-header">
      <h3>Editar datos de la empresa</h3>
      <button
        type="button"
        class="icon-btn"
        (click)="cancelForm('empresa')"
        aria-label="Cerrar"
      >
        ✕
      </button>
    </div>

    <form (ngSubmit)="onSubmitEmpresaEdit()" class="nice-form">
      <div class="modal-body grid-3">
        <div class="field">
          <label>Cant. empleados</label>
          <input
            type="number"
            [(ngModel)]="empresaEditForm.cant_empleados"
            name="cant_empleados"
          />
        </div>
        <div class="field">
          <label>Horario trabajo</label>
          <input
            type="text"
            [(ngModel)]="empresaEditForm.horario_trabajo"
            name="horario_trabajo"
            placeholder="Lun–Vie 8–17"
          />
        </div>
        <div class="field col-3">
          <label>Observaciones</label>
          <textarea
            rows="4"
            [(ngModel)]="empresaEditForm.observaciones"
            name="observaciones"
          ></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn primary" type="submit">Guardar cambios</button>
        <button class="btn ghost" type="button" (click)="cancelForm('empresa')">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Vehículo: crear/editar -->
<div class="overlay" *ngIf="showVehiculoForm">
  <div class="modal modal--lg">
    <div class="modal-header">
      <h3>{{ editingVehiculo ? "Editar vehículo" : "Nuevo vehículo" }}</h3>
      <button
        type="button"
        class="icon-btn"
        (click)="cancelForm('vehiculo')"
        aria-label="Cerrar"
      >
        ✕
      </button>
    </div>

    <!-- 👇 usa tu helper markAllAndSubmit(fVeh) -->
    <form
      (ngSubmit)="markAllAndSubmit(fVeh)"
      #fVeh="ngForm"
      class="nice-form"
      novalidate
    >
      <div class="modal-body grid-3">
        <!-- Tipo (req) -->
        <div class="field col-3">
          <label>Tipo <span class="req">*</span></label>
          <select
            [(ngModel)]="vehiculoForm.id_tipo_vehiculo"
            name="v_tipo"
            (ngModelChange)="onVehiculoTipoChange()"
            required
            #vTipo="ngModel"
          >
            <option [ngValue]="null">—</option>
            <option
              *ngFor="let t of tiposVehiculo"
              [ngValue]="t.id_tipo_vehiculo"
            >
              {{ t.tipo }}
            </option>
          </select>
          <div
            class="error"
            *ngIf="vTipo.invalid && (vTipo.touched || fVeh.submitted)"
          >
            Seleccioná un tipo.
          </div>
        </div>

        <!-- Horarios (req) -->
        <div class="field">
          <label>Horarios <span class="req">*</span></label>
          <input
            type="text"
            [(ngModel)]="vehiculoForm.horarios"
            name="v_horarios"
            required
            #vHor="ngModel"
            placeholder="08-18"
          />
          <div
            class="error"
            *ngIf="vHor.invalid && (vHor.touched || fVeh.submitted)"
          >
            Campo obligatorio.
          </div>
        </div>

        <!-- Frecuencia (req) -->
        <div class="field">
          <label>Frecuencia <span class="req">*</span></label>
          <input
            type="text"
            [(ngModel)]="vehiculoForm.frecuencia"
            name="v_frecuencia"
            required
            #vFreq="ngModel"
            placeholder="Diaria / Semanal"
          />
          <div
            class="error"
            *ngIf="vFreq.invalid && (vFreq.touched || fVeh.submitted)"
          >
            Campo obligatorio.
          </div>
        </div>

        <!-- Reglas por tipo -->
        <ng-container [ngSwitch]="vehiculoForm.id_tipo_vehiculo">
          <!-- 1: Corporativo (Cantidad, Patente, Carga) -->
          <ng-container *ngSwitchCase="1">
            <div class="field">
              <label>Cantidad <span class="req">*</span></label>
              <input
                type="number"
                [(ngModel)]="vehiculoForm.datos.cantidad"
                name="v_cant_corp"
                min="1"
                required
                #vCantCorp="ngModel"
              />
              <div
                class="error"
                *ngIf="
                  vCantCorp.invalid && (vCantCorp.touched || fVeh.submitted)
                "
              >
                Ingresá una cantidad ≥ 1.
              </div>
            </div>

            <div class="field">
              <label>Patente <span class="req">*</span></label>
              <input
                type="text"
                [(ngModel)]="vehiculoForm.datos.patente"
                name="v_pat_corp"
                required
                #vPatCorp="ngModel"
                placeholder="ABC123 / AA123AA"
              />
              <div
                class="error"
                *ngIf="vPatCorp.invalid && (vPatCorp.touched || fVeh.submitted)"
              >
                Campo obligatorio.
              </div>
            </div>

            <div class="field">
              <label>Carga <span class="req">*</span></label>
              <select
                [(ngModel)]="vehiculoForm.datos.carga"
                name="v_carga_corp"
                required
                #vCarCorp="ngModel"
              >
                <option [ngValue]="null">—</option>
                <option value="baja">Baja</option>
                <option value="mediana">Mediana</option>
                <option value="alta">Alta</option>
              </select>
              <div
                class="error"
                *ngIf="vCarCorp.invalid && (vCarCorp.touched || fVeh.submitted)"
              >
                Seleccioná la carga.
              </div>
            </div>
          </ng-container>

          <!-- 2: Personal (Cantidad req, Patente opcional) -->
          <ng-container *ngSwitchCase="2">
            <div class="field">
              <label>Cantidad <span class="req">*</span></label>
              <input
                type="number"
                [(ngModel)]="vehiculoForm.datos.cantidad"
                name="v_cant_per"
                min="1"
                required
                #vCantPer="ngModel"
              />
              <div
                class="error"
                *ngIf="vCantPer.invalid && (vCantPer.touched || fVeh.submitted)"
              >
                Ingresá una cantidad ≥ 1.
              </div>
            </div>

            <div class="field">
              <label>Patente</label>
              <input
                type="text"
                [(ngModel)]="vehiculoForm.datos.patente"
                name="v_pat_per"
                placeholder="ABC123 / AA123AA"
              />
            </div>
          </ng-container>

          <!-- 3: Terceros (Cantidad y Carga req) -->
          <ng-container *ngSwitchCase="3">
            <div class="field">
              <label>Cantidad <span class="req">*</span></label>
              <input
                type="number"
                [(ngModel)]="vehiculoForm.datos.cantidad"
                name="v_cant_ter"
                min="1"
                required
                #vCantTer="ngModel"
              />
              <div
                class="error"
                *ngIf="vCantTer.invalid && (vCantTer.touched || fVeh.submitted)"
              >
                Ingresá una cantidad ≥ 1.
              </div>
            </div>

            <div class="field">
              <label>Carga <span class="req">*</span></label>
              <select
                [(ngModel)]="vehiculoForm.datos.carga"
                name="v_carga_ter"
                required
                #vCarTer="ngModel"
              >
                <option [ngValue]="null">—</option>
                <option value="baja">Baja</option>
                <option value="mediana">Mediana</option>
                <option value="alta">Alta</option>
              </select>
              <div
                class="error"
                *ngIf="vCarTer.invalid && (vCarTer.touched || fVeh.submitted)"
              >
                Seleccioná la carga.
              </div>
            </div>
          </ng-container>
        </ng-container>
      </div>

      <div class="modal-actions">
        <button class="btn primary" type="submit" [disabled]="fVeh.invalid">
          {{ editingVehiculo ? "Actualizar" : "Agregar" }}
        </button>
        <button
          class="btn ghost"
          type="button"
          (click)="cancelForm('vehiculo')"
        >
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Contacto: crear/editar -->
<div class="overlay" *ngIf="showContactoForm">
  <div class="modal modal--md">
    <div class="modal-header">
      <h3>
        {{ editingContacto ? "Editar contacto" : "Nuevo contacto" }}
      </h3>
      <button
        type="button"
        class="icon-btn"
        (click)="cancelForm('contacto')"
        aria-label="Cerrar"
      >
        ✕
      </button>
    </div>

    <form
      (ngSubmit)="onSubmitContacto()"
      class="nice-form"
      #fCont="ngForm"
      novalidate
    >
      <div class="modal-body grid-3">
        <div class="field">
          <label>Tipo <span class="req">*</span></label>
          <select
            [(ngModel)]="contactoForm.id_tipo_contacto"
            name="c_tipo"
            required
            #cTipo="ngModel"
            (ngModelChange)="onTipoContactoChange()"
          >
            <option [ngValue]="null">—</option>
            <option
              *ngFor="let t of tiposContacto"
              [ngValue]="t.id_tipo_contacto"
            >
              {{ t.tipo }}
            </option>
          </select>
          <div
            class="error"
            *ngIf="cTipo.invalid && (cTipo.touched || fCont.submitted)"
          >
            Seleccioná un tipo.
          </div>
        </div>

        <div class="field">
          <label>Nombre <span class="req">*</span></label>
          <input
            type="text"
            [(ngModel)]="contactoForm.nombre"
            name="c_nombre"
            required
            #cNom="ngModel"
          />
          <div
            class="error"
            *ngIf="cNom.invalid && (cNom.touched || fCont.submitted)"
          >
            Ingresá un nombre.
          </div>
        </div>

        <div class="field">
          <label>Teléfono <span class="req">*</span></label>
          <input
            type="text"
            [(ngModel)]="contactoForm.telefono"
            name="c_telefono"
            required
            #cTel="ngModel"
            placeholder="Ej: +54 9 11 1234-5678"
          />
          <div
            class="error"
            *ngIf="cTel.invalid && (cTel.touched || fCont.submitted)"
          >
            Ingresá un teléfono.
          </div>
        </div>

        <div class="field col-3">
          <label>Dirección <span class="req">*</span></label>
          <input
            type="text"
            [(ngModel)]="contactoForm.direccion"
            name="c_direccion"
            required
            #cDir="ngModel"
            placeholder="Calle 123, Ciudad"
          />
          <div
            class="error"
            *ngIf="cDir.invalid && (cDir.touched || fCont.submitted)"
          >
            Ingresá una dirección.
          </div>
        </div>

        <!-- Comerciales (id=1) -->
        <div class="field col-3" *ngIf="contactoForm.id_tipo_contacto === 1">
          <label>Datos comerciales</label>
          <div class="inline-3">
            <input
              type="url"
              [(ngModel)]="contactoForm.datos.pagina_web"
              name="c_web"
              placeholder="https://empresa.com"
            />
            <input
              type="email"
              [(ngModel)]="contactoForm.datos.correo"
              name="c_mail"
              placeholder="mail@empresa.com"
            />
            <input
              type="text"
              [(ngModel)]="contactoForm.datos.redes_sociales"
              name="c_rrss"
              placeholder="@empresa"
            />
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn primary" type="submit" [disabled]="fCont.invalid">
          {{ editingContacto ? "Actualizar" : "Agregar" }}
        </button>
        <button
          class="btn ghost"
          type="button"
          (click)="cancelForm('contacto')"
        >
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Servicio propio: crear/editar -->
<div class="overlay" *ngIf="showServicioForm">
  <div class="modal modal--md">
    <div class="modal-header">
      <h3>
        {{ editingServicio ? "Editar servicio" : "Nuevo servicio" }}
      </h3>
      <button
        type="button"
        class="icon-btn"
        (click)="cancelForm('servicio')"
        aria-label="Cerrar"
      >
        ✕
      </button>
    </div>

    <form
      (ngSubmit)="onSubmitServicio()"
      #fServ="ngForm"
      class="nice-form"
      novalidate
    >
      <div class="modal-body grid-3">
        <div class="field">
          <label>Tipo <span class="req">*</span></label>
          <select
            [(ngModel)]="servicioForm.id_tipo_servicio"
            (ngModelChange)="onTipoServicioChange()"
            name="s_tipo"
            required
            #sTipo="ngModel"
          >
            <option [ngValue]="null">—</option>
            <option
              *ngFor="let t of tiposServicio"
              [ngValue]="t.id_tipo_servicio"
            >
              {{ t.tipo }}
            </option>
          </select>
          <div
            class="error"
            *ngIf="sTipo.invalid && (sTipo.touched || fServ.submitted)"
          >
            Seleccioná un tipo.
          </div>
        </div>

        <ng-container [ngSwitch]="servicioForm.id_tipo_servicio">
          <!-- 1: Agua -->
          <ng-container *ngSwitchCase="1">
            <div class="field col-3"><label>Servicio de Agua</label></div>
            <div class="field col-3">
              <label>Biofiltro <span class="req">*</span></label>
              <input
                type="text"
                [(ngModel)]="servicioForm.datos.biofiltro"
                name="s_biofiltro"
                required
                #sBio="ngModel"
              />
              <div
                class="error"
                *ngIf="sBio.invalid && (sBio.touched || fServ.submitted)"
              >
                Campo obligatorio.
              </div>
            </div>
            <div class="field col-3">
              <label>Tratamiento aguas grises <span class="req">*</span></label>
              <input
                type="text"
                [(ngModel)]="servicioForm.datos.tratamiento_aguas_grises"
                name="s_aguas"
                required
                #sAguas="ngModel"
              />
              <div
                class="error"
                *ngIf="sAguas.invalid && (sAguas.touched || fServ.submitted)"
              >
                Campo obligatorio.
              </div>
            </div>
          </ng-container>

          <!-- 2: Espacios Verdes -->
          <ng-container *ngSwitchCase="2">
            <div class="field col-3">
              <label>Servicio de Espacios Verdes</label>
            </div>
            <div class="field col-3">
              <label>Abierto al público <span class="req">*</span></label>
              <input
                type="text"
                [(ngModel)]="servicioForm.datos.abierto"
                name="s_abierto"
                required
                #sAbierto="ngModel"
              />
              <div
                class="error"
                *ngIf="
                  sAbierto.invalid && (sAbierto.touched || fServ.submitted)
                "
              >
                Campo obligatorio.
              </div>
            </div>
            <div class="field col-3">
              <label>Superficie (m²) <span class="req">*</span></label>
              <input
                type="number"
                [(ngModel)]="servicioForm.datos.m2"
                name="s_m2"
                min="1"
                required
                #sM2="ngModel"
              />
              <div
                class="error"
                *ngIf="sM2.invalid && (sM2.touched || fServ.submitted)"
              >
                Ingresá un valor ≥ 1.
              </div>
            </div>
          </ng-container>

          <!-- 3: Internet -->
          <ng-container *ngSwitchCase="3">
            <div class="field col-3"><label>Servicio de Internet</label></div>
            <div class="field col-3">
              <label>Tipo <span class="req">*</span></label>
              <input
                type="text"
                [(ngModel)]="servicioForm.datos.tipo"
                name="s_tipo_con"
                required
                #sTipoCon="ngModel"
              />
              <div
                class="error"
                *ngIf="
                  sTipoCon.invalid && (sTipoCon.touched || fServ.submitted)
                "
              >
                Campo obligatorio.
              </div>
            </div>
            <div class="field col-3">
              <label>Proveedor <span class="req">*</span></label>
              <input
                type="text"
                [(ngModel)]="servicioForm.datos.proveedor"
                name="s_proveedor"
                required
                #sProv="ngModel"
              />
              <div
                class="error"
                *ngIf="sProv.invalid && (sProv.touched || fServ.submitted)"
              >
                Campo obligatorio.
              </div>
            </div>
          </ng-container>

          <!-- 4: Residuos -->
          <ng-container *ngSwitchCase="4">
            <div class="field col-3"><label>Servicio de Residuos</label></div>
            <div class="field col-3">
              <label>Tipo residuo <span class="req">*</span></label>
              <input
                type="text"
                [(ngModel)]="servicioForm.datos.tipo"
                name="s_tipo_e"
                required
                #sTipoRes="ngModel"
              />
              <div
                class="error"
                *ngIf="
                  sTipoRes.invalid && (sTipoRes.touched || fServ.submitted)
                "
              >
                Campo obligatorio.
              </div>
            </div>
            <div class="field col-3">
              <label>Cantidad recolectada <span class="req">*</span></label>
              <input
                type="number"
                [(ngModel)]="servicioForm.datos.cantidad"
                name="s_cantidad"
                min="1"
                required
                #sCant="ngModel"
              />
              <div
                class="error"
                *ngIf="sCant.invalid && (sCant.touched || fServ.submitted)"
              >
                Ingresá un valor ≥ 1.
              </div>
            </div>
          </ng-container>
        </ng-container>
      </div>

      <div class="modal-actions">
        <button class="btn primary" type="submit" [disabled]="fServ.invalid">
          {{ editingServicio ? "Actualizar" : "Agregar" }}
        </button>
        <button
          class="btn ghost"
          type="button"
          (click)="cancelForm('servicio')"
        >
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>
