<!-- admin-polo.component.html -->
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Material+Symbols+Outlined:FILL@0..1"
  rel="stylesheet"
/>

<div class="admin-layout">
  <!-- Topbar -->
  <nav class="topbar">
    <div class="topbar-left">
      <img
        class="brand-logo"
        src="../../assets/images/polologo-blanco.png"
        alt="Polo 52"
      />
      <div class="topbar-title">
        <div class="app-title">POLO 52</div>
        <div class="app-sub">Administración</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="topbar-tabs">
      <button
        class="tab"
        [class.active]="activeTab === 'perfil'"
        (click)="setActiveTab('perfil')"
      >
        Perfil
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'empresas'"
        (click)="setActiveTab('empresas')"
      >
        Empresas
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'usuarios'"
        (click)="setActiveTab('usuarios')"
      >
        Usuarios
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'servicios'"
        (click)="setActiveTab('servicios')"
      >
        Servicios Polo
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'lotes'"
        (click)="setActiveTab('lotes')"
      >
        Lotes
      </button>
    </div>

    <div class="topbar-right">
      <button class="pill">Panel Polo</button>
      <button
        class="ghost topbar-icon-btn"
        type="button"
        (click)="setActiveTab('config')"
        aria-label="Abrir configuración"
      >
        <span class="material-symbols-outlined">settings</span>
      </button>
      <app-logout-button></app-logout-button>
    </div>
  </nav>

  <!-- Main -->
  <main class="content">
    <!-- PERFIL POLO -->
    <section *ngIf="activeTab === 'perfil'" class="card-grid">
      <div class="card">
        <h2>Datos del Polo</h2>
        <div class="grid-3 nice-form">
          <div class="field">
            <label>CUIL</label>
            <input type="text" [value]="poloData?.cuil" disabled />
          </div>
          <div class="field">
            <label>Nombre</label>
            <input type="text" [value]="poloData?.nombre" disabled />
          </div>
          <div class="field">
            <label>Rubro</label>
            <input type="text" [value]="poloData?.rubro" disabled />
          </div>
          <div class="field">
            <label>Fecha ingreso</label>
            <input type="text" [value]="poloData?.fecha_ingreso" disabled />
          </div>
          <div class="field">
            <label>Cant. empleados</label>
            <input
              class="readout"
              type="text"
              [value]="poloData?.cant_empleados || '—'"
              disabled
            />
          </div>
          <div class="field">
            <label>Horario trabajo</label>
            <input
              class="readout"
              type="text"
              [value]="poloData?.horario_trabajo || '—'"
              disabled
            />
          </div>
          <div class="field col-3">
            <label>Observaciones</label>
            <textarea
              class="readout"
              rows="3"
              [value]="poloData?.observaciones || '—'"
              disabled
            ></textarea>
          </div>
        </div>
        <div class="actions" style="margin-top: 1rem">
          <button
            class="btn primary"
            type="button"
            (click)="openPoloEditForm()"
          >
            <span class="material-symbols-outlined">edit</span>
            <span>Editar datos del Polo</span>
          </button>
        </div>
      </div>
    </section>

    <!-- EMPRESAS -->
    <section *ngIf="activeTab === 'empresas'" class="card-stack">
      <div class="card">
        <div class="page-header">
          <div class="actions">
            <!-- IZQUIERDA: botón -->
            <div class="actions-left">
              <button
                class="btn primary"
                type="button"
                (click)="openEmpresaForm()"
              >
                <span class="material-symbols-outlined">add_circle</span>
                <span>Nueva empresa</span>
              </button>
            </div>

            <!-- DERECHA: buscador -->
            <div class="inline-search">
              <input
                type="text"
                placeholder="Buscar por nombre, CUIL o rubro…"
                [(ngModel)]="empresaSearchTerm"
                (input)="filterEmpresas()"
              />
              <button
                class="btn ghost"
                type="button"
                (click)="clearEmpresaSearch()"
              >
                Limpiar
              </button>
            </div>
          </div>
        </div>

        <div class="table">
          <div class="thead">
            <div>CUIL</div>
            <div>Nombre</div>
            <div>Rubro</div>
            <div>Empleados</div>
            <div>Horario</div>
            <div>Acciones</div>
          </div>

          <div class="row" *ngFor="let e of filteredEmpresas">
            <div>{{ e.cuil }}</div>
            <div>{{ e.nombre }}</div>
            <div>{{ e.rubro }}</div>
            <div>{{ e.cant_empleados }}</div>
            <div>{{ e.horario_trabajo || "—" }}</div>

            <div class="row-actions">
              <button
                class="btn icon"
                title="Editar"
                (click)="openEmpresaForm(e)"
              >
                <span class="material-symbols-outlined">edit</span>
              </button>
              <button
                class="btn icon"
                title="Usuario para empresa"
                (click)="createUsuarioForEmpresa(e)"
              >
                <span class="material-symbols-outlined">person_add</span>
              </button>
              <button
                class="btn icon"
                title="Servicio del Polo para empresa"
                (click)="createServicioPoloForEmpresa(e)"
              >
                <span class="material-symbols-outlined">add_business</span>
              </button>
              <button
                class="btn icon danger"
                title="Eliminar"
                (click)="deleteEmpresa(e.cuil)"
              >
                <span class="material-symbols-outlined">delete</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- USUARIOS -->
    <section *ngIf="activeTab === 'usuarios'" class="card-stack">
      <div class="card">
        <div class="page-header">
          <div class="actions">
            <!-- IZQUIERDA: botón principal -->
            <div class="actions-left">
              <button
                class="btn primary"
                type="button"
                (click)="openUsuarioForm()"
              >
                <span class="material-symbols-outlined">person_add</span>
                <span>Nuevo usuario</span>
              </button>
            </div>

            <!-- DERECHA: buscador (más largo) -->
            <div class="inline-search">
              <input
                type="text"
                placeholder="Buscar por nombre, email o CUIL…"
                [(ngModel)]="usuarioSearchTerm"
                (input)="filterUsuarios()"
              />
              <button
                class="btn ghost"
                type="button"
                (click)="clearUsuarioSearch()"
              >
                Limpiar
              </button>
            </div>
          </div>
        </div>

        <div class="table">
          <div class="thead">
            <div>Email</div>
            <div>Nombre</div>
            <div>CUIL</div>
            <div>Estado</div>
            <div>Acciones</div>
          </div>

          <div class="row" *ngFor="let u of filteredUsuarios">
            <div>{{ u.email }}</div>
            <div>{{ u.nombre }}</div>
            <div>{{ u.cuil }}</div>
            <div>
              <span
                class="badge"
                [class.badge--ok]="u.estado"
                [class.badge--off]="!u.estado"
              >
                {{ u.estado ? "Habilitado" : "Inhabilitado" }}
              </span>
            </div>

            <div class="row-actions">
              <button
                class="btn icon"
                title="Editar"
                (click)="openUsuarioForm(u)"
              >
                <span class="material-symbols-outlined">edit</span>
              </button>
              <button
                class="btn icon"
                [class.danger]="u.estado"
                [title]="u.estado ? 'Inhabilitar' : 'Habilitar'"
                (click)="toggleUsuarioEstado(u)"
              >
                <span class="material-symbols-outlined">{{
                  u.estado ? "block" : "check_circle"
                }}</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SERVICIOS DEL POLO -->
    <section *ngIf="activeTab === 'servicios'" class="card-stack">
      <div class="card">
        <div class="page-header">
          <div class="actions">
            <div class="actions-left">
              <button
                class="btn primary"
                type="button"
                (click)="openServicioPoloForm()"
              >
                <span class="material-symbols-outlined">add_circle</span>
                <span>Nuevo servicio</span>
              </button>
            </div>

            <div class="inline-search">
              <input
                type="text"
                placeholder="Buscar por nombre, CUIL o propietario…"
                [(ngModel)]="servicioSearchTerm"
                (input)="filterServicios()"
              />
              <button
                class="btn ghost"
                type="button"
                (click)="clearServicioSearch()"
              >
                Limpiar
              </button>
            </div>
          </div>
        </div>

        <div class="table">
          <div class="thead">
            <div>Nombre</div>
            <div>Horario</div>
            <div>Propietario</div>
            <div>CUIL</div>
            <div>Acciones</div>
          </div>

          <div class="row" *ngFor="let s of filteredServicios">
            <div>{{ s.nombre }}</div>
            <div>{{ s.horario || "—" }}</div>
            <div>{{ s.propietario || "—" }}</div>
            <div>{{ s.cuil }}</div>

            <div class="row-actions">
              <button
                class="btn icon"
                title="Agregar/Asignar lote"
                (click)="openLoteForm(s.id_servicio_polo, s.nombre)"
              >
                <span class="material-symbols-outlined">add_home_work</span>
              </button>
              <button
                class="btn icon danger"
                title="Eliminar servicio"
                (click)="deleteServicioPolo(s.id_servicio_polo)"
              >
                <span class="material-symbols-outlined">delete</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- LOTES -->
    <section *ngIf="activeTab === 'lotes'" class="card-stack">
      <div class="card">
        <div class="page-header">
          <div class="actions">
            <div class="inline-search">
              <input
                type="text"
                placeholder="Buscar por dueño, lote o manzana…"
                [(ngModel)]="loteSearchTerm"
                (input)="filterLotes()"
              />
              <button
                class="btn ghost"
                type="button"
                (click)="clearLoteSearch()"
              >
                Limpiar
              </button>
            </div>
          </div>
        </div>

        <div class="table">
          <div class="thead">
            <div>Dueño</div>
            <div>Manzana</div>
            <div>Lote</div>
            <div>Servicio</div>
            <div>Acciones</div>
          </div>

          <div class="row" *ngFor="let l of filteredLotes">
            <div>{{ l.dueno }}</div>
            <div>{{ l.manzana }}</div>
            <div>{{ l.lote }}</div>
            <div>{{ l.id_servicio_polo }}</div>
            <div class="row-actions">
              <button
                class="btn icon danger"
                title="Eliminar lote"
                (click)="deleteLote(l.id_lotes)"
              >
                <span class="material-symbols-outlined">delete</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CONFIGURACIÓN -->
    <section *ngIf="activeTab === 'config'" class="card-grid">
      <div class="card setting-card">
        <div class="setting-header">
          <span class="material-symbols-outlined setting-icon">vpn_key</span>
          <div>
            <h2>Contraseña</h2>
            <p class="muted">Actualizar contraseña de acceso</p>
          </div>
        </div>
        <button
          class="btn outline-primary"
          type="button"
          (click)="openPasswordModal()"
        >
          <span class="material-symbols-outlined">edit</span>
          <span>Cambiar contraseña</span>
        </button>
        <app-password-change-modal
          #passwordModal
          [showModal]="showPasswordModal"
          (modalClosed)="onPasswordModalClosed()"
          (passwordChanged)="onPasswordChanged($event)"
        ></app-password-change-modal>
      </div>

      <div class="card setting-card">
        <div class="setting-header">
          <span class="material-symbols-outlined setting-icon danger"
            >logout</span
          >
          <div>
            <h2>Sesión</h2>
            <p class="muted">Salir de la cuenta del Polo</p>
          </div>
        </div>
        <app-logout-button></app-logout-button>
      </div>
    </section>
  </main>
</div>

<!-- ===================== MODALES ===================== -->

<!-- Editar Polo -->
<div class="overlay" *ngIf="showPoloEditForm">
  <div class="modal modal--md">
    <div class="modal-header">
      <h3>Editar datos del Polo</h3>
      <button
        type="button"
        class="icon-btn"
        (click)="cancelForm('polo')"
        aria-label="Cerrar"
      >
        ✕
      </button>
    </div>

    <form (ngSubmit)="onSubmitPoloEdit()" class="nice-form">
      <div class="modal-body grid-3">
        <div class="field">
          <label>Cant. empleados</label>
          <input
            type="number"
            [(ngModel)]="poloEditForm.cant_empleados"
            name="p_cant_empleados"
          />
        </div>
        <div class="field">
          <label>Horario trabajo</label>
          <input
            type="text"
            [(ngModel)]="poloEditForm.horario_trabajo"
            name="p_horario"
            placeholder="Lun–Vie 8–17"
          />
        </div>
        <div class="field col-3">
          <label>Observaciones</label>
          <textarea
            rows="4"
            [(ngModel)]="poloEditForm.observaciones"
            name="p_obs"
          ></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn primary" type="submit">Guardar cambios</button>
        <button class="btn ghost" type="button" (click)="cancelForm('polo')">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Empresa: crear/editar -->
<div class="overlay" *ngIf="showEmpresaForm">
  <div class="modal modal--md">
    <div class="modal-header">
      <h3>{{ editingEmpresa ? "Editar empresa" : "Nueva empresa" }}</h3>
      <button
        type="button"
        class="icon-btn"
        (click)="cancelForm('empresa')"
        aria-label="Cerrar"
      >
        ✕
      </button>
    </div>

    <form (ngSubmit)="onSubmitEmpresa()" class="nice-form">
      <div class="modal-body">
        <div class="field">
          <label>CUIL</label>
          <input
            type="number"
            [(ngModel)]="empresaForm.cuil"
            name="e_cuil"
            [disabled]="!!editingEmpresa"
          />
        </div>
        <div class="field">
          <label>Nombre</label>
          <input
            type="text"
            [(ngModel)]="empresaForm.nombre"
            name="e_nombre"
            required
          />
        </div>
        <div class="field">
          <label>Rubro</label>
          <input
            type="text"
            [(ngModel)]="empresaForm.rubro"
            name="e_rubro"
            required
          />
        </div>
        <div class="field">
          <label>Cant. empleados</label>
          <input
            type="number"
            [(ngModel)]="empresaForm.cant_empleados"
            name="e_empleados"
          />
        </div>
        <div class="field">
          <label>Horario trabajo</label>
          <input
            type="text"
            [(ngModel)]="empresaForm.horario_trabajo"
            name="e_horario"
          />
        </div>
        <div class="field col-3">
          <label>Observaciones</label>
          <textarea
            rows="3"
            [(ngModel)]="empresaForm.observaciones"
            name="e_obs"
          ></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn primary" type="submit">
          {{ editingEmpresa ? "Actualizar" : "Crear" }}
        </button>
        <button class="btn ghost" type="button" (click)="cancelForm('empresa')">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Usuario: crear/editar -->
<div class="overlay" *ngIf="showUsuarioForm">
  <div class="modal modal--md">
    <div class="modal-header">
      <h3>{{ editingUsuario ? "Editar usuario" : "Nuevo usuario" }}</h3>
      <button
        type="button"
        class="icon-btn"
        (click)="cancelForm('usuario')"
        aria-label="Cerrar"
      >
        ✕
      </button>
    </div>

    <form (ngSubmit)="onSubmitUsuario()" class="nice-form">
      <div class="modal-body grid-3">
        <div class="field">
          <label>Email</label>
          <input
            type="email"
            [(ngModel)]="usuarioForm.email"
            name="u_email"
            [disabled]="!!editingUsuario"
            required
          />
        </div>
        <div class="field">
          <label>Nombre</label>
          <input
            type="text"
            [(ngModel)]="usuarioForm.nombre"
            name="u_nombre"
            required
          />
        </div>
        <div class="field" *ngIf="!editingUsuario">
          <label>Rol</label>
          <select [(ngModel)]="usuarioForm.id_rol" name="u_rol" required>
            <option [ngValue]="null">—</option>
            <option *ngFor="let r of roles" [ngValue]="r.id_rol">
              {{ r.tipo_rol }}
            </option>
          </select>
        </div>
        <div class="field">
          <label>CUIL (empresa)</label>
          <input
            type="number"
            [(ngModel)]="usuarioForm.cuil"
            name="u_cuil"
            [disabled]="!!editingUsuario || creatingForEmpresa"
            required
          />
        </div>
        <div class="field">
          <label>Estado</label>
          <select [(ngModel)]="usuarioForm.estado" name="u_estado">
            <option [ngValue]="true">Habilitado</option>
            <option [ngValue]="false">Inhabilitado</option>
          </select>
        </div>
        <div class="field" *ngIf="editingUsuario">
          <label>Nueva contraseña (opcional)</label>
          <input
            type="password"
            [(ngModel)]="usuarioForm.password"
            name="u_password"
            placeholder="••••••"
          />
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn primary" type="submit">
          {{ editingUsuario ? "Actualizar" : "Crear" }}
        </button>
        <button class="btn ghost" type="button" (click)="cancelForm('usuario')">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Servicio del Polo: crear -->
<div class="overlay" *ngIf="showServicioPoloForm">
  <div class="modal modal--md">
    <div class="modal-header">
      <h3>Nuevo servicio del Polo</h3>
      <button
        type="button"
        class="icon-btn"
        (click)="cancelForm('servicioPolo')"
        aria-label="Cerrar"
      >
        ✕
      </button>
    </div>

    <form (ngSubmit)="onSubmitServicioPolo()" class="nice-form">
      <div class="modal-body grid-3">
        <div class="field">
          <label>Nombre</label>
          <input
            type="text"
            [(ngModel)]="servicioPoloForm.nombre"
            name="sp_nombre"
            required
          />
        </div>
        <div class="field">
          <label>Tipo</label>
          <select
            [(ngModel)]="servicioPoloForm.id_tipo_servicio_polo"
            name="sp_tipo"
            (ngModelChange)="onTipoServicioChange()"
            required
          >
            <option [ngValue]="1">Coworking</option>
            <option [ngValue]="2">Espacios verdes</option>
            <option [ngValue]="3">Internet</option>
            <option [ngValue]="4">Residuos</option>
          </select>
        </div>
        <div class="field">
          <label>Horario</label>
          <input
            type="text"
            [(ngModel)]="servicioPoloForm.horario"
            name="sp_horario"
            placeholder="08–18"
          />
        </div>
        <div class="field">
          <label>Propietario</label>
          <select
            [(ngModel)]="servicioPoloForm.propietario"
            name="sp_propietario"
            (ngModelChange)="onPropietarioChange()"
          >
            <option value="">—</option>
            <option value="propietario">Propietario</option>
            <option value="inquilino">Inquilino</option>
          </select>
        </div>
        <div class="field">
          <label>CUIL (empresa)</label>
          <input
            type="number"
            [(ngModel)]="servicioPoloForm.cuil"
            name="sp_cuil"
            [disabled]="creatingForEmpresa"
            required
          />
        </div>

        <!-- Campos dinámicos -->
        <div class="field" *ngIf="isCantPuestosRequired()">
          <label>Cant. puestos</label>
          <input
            type="number"
            [(ngModel)]="servicioPoloForm.datos.cant_puestos"
            name="sp_puestos"
          />
        </div>
        <div class="field" *ngIf="isM2Required()">
          <label>Superficie (m²)</label>
          <input
            type="number"
            [(ngModel)]="servicioPoloForm.datos.m2"
            name="sp_m2"
          />
        </div>

        <div
          class="field col-3"
          *ngIf="servicioPoloForm.propietario === 'propietario'"
        >
          <label>Datos del propietario</label>
          <div class="inline-3">
            <input
              type="text"
              [(ngModel)]="servicioPoloForm.datos.datos_prop.nombre"
              name="sp_prop_nombre"
              placeholder="Nombre"
            />
            <input
              type="text"
              [(ngModel)]="servicioPoloForm.datos.datos_prop.contacto"
              name="sp_prop_contacto"
              placeholder="Contacto"
            />
            <input type="text" disabled placeholder="—" />
          </div>
        </div>

        <div
          class="field col-3"
          *ngIf="servicioPoloForm.propietario === 'inquilino'"
        >
          <label>Datos del inquilino</label>
          <div class="inline-3">
            <input
              type="text"
              [(ngModel)]="servicioPoloForm.datos.datos_inquilino.nombre"
              name="sp_inq_nombre"
              placeholder="Nombre"
            />
            <input
              type="text"
              [(ngModel)]="servicioPoloForm.datos.datos_inquilino.contacto"
              name="sp_inq_contacto"
              placeholder="Contacto"
            />
            <input type="text" disabled placeholder="—" />
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn primary" type="submit">Crear</button>
        <button
          class="btn ghost"
          type="button"
          (click)="cancelForm('servicioPolo')"
        >
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Lote: crear -->
<div class="overlay" *ngIf="showLoteForm">
  <div class="modal modal--sm">
    <div class="modal-header">
      <h3>
        Nuevo lote
        {{
          nombreServicioSeleccionado ? "para " + nombreServicioSeleccionado : ""
        }}
      </h3>
      <button
        type="button"
        class="icon-btn"
        (click)="cancelForm('lote')"
        aria-label="Cerrar"
      >
        ✕
      </button>
    </div>

    <form (ngSubmit)="onSubmitLote()" class="nice-form">
      <div class="modal-body grid-3">
        <div class="field">
          <label>Dueño</label>
          <input
            type="text"
            [(ngModel)]="loteForm.dueno"
            name="l_dueno"
            required
          />
        </div>
        <div class="field">
          <label>Manzana</label>
          <input
            type="number"
            [(ngModel)]="loteForm.manzana"
            name="l_manzana"
            required
          />
        </div>
        <div class="field">
          <label>Lote</label>
          <input
            type="number"
            [(ngModel)]="loteForm.lote"
            name="l_lote"
            required
          />
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn primary" type="submit">Agregar</button>
        <button class="btn ghost" type="button" (click)="cancelForm('lote')">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>
